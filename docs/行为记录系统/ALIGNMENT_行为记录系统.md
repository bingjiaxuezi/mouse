# 小鼠行为记录系统需求对齐文档

## 项目上下文分析

### 现有项目架构
- **后端框架**: RuoYi (Spring Boot + MyBatis)
- **前端技术**: Thymeleaf + jQuery + Bootstrap
- **数据库**: MySQL 8.0
- **部署方式**: Docker Compose
- **现有功能**: 小鼠管理系统 (t_mouse表)

### 现有代码模式
- **分层架构**: Controller -> Service -> Mapper -> Entity
- **DTO/VO模式**: 使用DTO接收请求，VO返回响应
- **权限控制**: 基于Shiro的权限注解
- **页面模式**: Thymeleaf模板 + AJAX交互
- **数据表格**: 使用Bootstrap Table组件

### 数据库现状
- **核心表**: t_mouse (小鼠基础信息)
- **新增表**: 
  - t_behavior_type (行为类型字典，19种行为)
  - t_behavior_data (行为数据记录)
  - t_position_track (位置轨迹)
  - t_physiological_state (生理状态)

## 原始需求分析

### 核心需求
1. **测试数据**: 为新建表添加测试数据，同步到初始化脚本
2. **行为记录页面**: 创建完整的前后端系统
3. **双入口设计**: 
   - 独立的行为管理菜单
   - 从小鼠详情页进入特定小鼠的行为信息
4. **页面功能**:
   - 汇总统计 (24小时内行为统计)
   - 行为记录列表 (从新到旧排序)
   - 小鼠状态信息展示

### 功能细节
- **汇总信息**: 24小时内基础行为、社交行为、异常行为统计
- **列表展示**: 行为记录按时间倒序，包含小鼠名称、状态、笼子信息
- **状态信息**: 小鼠最新生理状态、生命状态

## 边界确认

### 包含范围
✅ 测试数据生成和数据库初始化脚本更新
✅ 完整的后端API开发 (Service、Controller、Mapper)
✅ 前端页面开发 (列表页、统计页)
✅ 菜单系统集成
✅ 小鼠详情页行为信息集成
✅ 一键部署验证

### 排除范围
❌ 实时数据采集功能
❌ 数据可视化图表 (超出基础展示需求)
❌ 行为数据的增删改功能 (只做展示)
❌ 复杂的数据分析算法

## 需求理解

### 对现有项目的理解
1. **代码风格**: 遵循RuoYi框架规范，使用Lombok简化代码
2. **权限模式**: 使用@RequiresPermissions注解控制访问权限
3. **前端交互**: 基于jQuery + Bootstrap的传统Web应用
4. **数据处理**: 使用MyBatis进行数据库操作
5. **异常处理**: 统一的AjaxResult返回格式

### 技术约束
- 必须与现有RuoYi框架兼容
- 前端必须使用Thymeleaf模板引擎
- 数据库操作必须通过MyBatis
- 权限控制必须集成现有Shiro系统
- 部署必须支持Docker Compose

## 疑问澄清

### 已明确的设计决策
1. **数据展示模式**: 只读展示，不提供行为数据的增删改功能
2. **时间范围**: 默认24小时，支持时间范围选择
3. **排序方式**: 行为记录按创建时间倒序
4. **页面布局**: 上部汇总统计，下部详细列表
5. **导航方式**: 双入口 (独立菜单 + 小鼠详情集成)

### 技术实现决策
1. **实体设计**: 复用现有的行为数据表结构
2. **权限设计**: 新增behavior相关权限点
3. **菜单集成**: 在系统管理模块下新增行为管理
4. **API设计**: RESTful风格，与现有mouse API保持一致

## 验收标准

### 功能验收
- [ ] 数据库包含足够的测试数据
- [ ] 行为管理独立页面正常访问
- [ ] 小鼠详情页集成行为信息
- [ ] 24小时行为统计准确显示
- [ ] 行为记录列表正确排序和分页
- [ ] 所有页面响应式布局正常

### 技术验收
- [ ] 代码符合RuoYi框架规范
- [ ] 所有API接口正常响应
- [ ] 权限控制正确生效
- [ ] 数据库查询性能良好
- [ ] 一键部署脚本执行成功
- [ ] 前后端联调通过

### 质量验收
- [ ] 代码注释完整
- [ ] 异常处理完善
- [ ] 用户体验良好
- [ ] 与现有系统风格一致

## 风险评估

### 技术风险
- **低风险**: 基于成熟的RuoYi框架开发
- **中风险**: 多表关联查询的性能优化
- **低风险**: 前端页面集成现有样式

### 集成风险
- **低风险**: 数据库外键约束已验证
- **低风险**: 权限系统集成
- **中风险**: 菜单系统修改可能影响现有功能

## 实现优先级

### 高优先级 (核心功能)
1. 测试数据准备
2. 后端API开发
3. 基础前端页面

### 中优先级 (增强功能)
4. 统计汇总功能
5. 小鼠详情集成
6. 菜单系统集成

### 低优先级 (完善功能)
7. 样式优化
8. 性能调优
9. 部署验证

## 技术实现方案

### 后端架构
```
Controller层: BehaviorController
├── 行为列表查询 (/behavior/list)
├── 行为统计查询 (/behavior/statistics)
├── 小鼠行为查询 (/behavior/mouse/{mouseCode})
└── 行为详情查询 (/behavior/{id})

Service层: IBehaviorService
├── 分页查询行为数据
├── 统计行为类型分布
├── 查询小鼠最新状态
└── 多表关联查询优化

Mapper层: BehaviorMapper
├── 基础CRUD操作
├── 复杂统计查询
├── 多表关联查询
└── 性能优化索引
```

### 前端架构
```
页面结构:
├── behavior/behavior.html (独立行为管理页)
├── behavior/mouse-behavior.html (小鼠行为详情页)
├── system/mouse/detail.html (小鼠详情页集成)
└── 共用组件和样式

功能模块:
├── 行为统计汇总组件
├── 行为列表展示组件
├── 时间范围选择组件
└── 小鼠信息展示组件
```

### 数据库设计
```sql
-- 主要查询场景
1. 按小鼠查询行为记录
2. 按时间范围统计行为类型
3. 查询小鼠最新状态
4. 多表关联查询优化

-- 索引优化
INDEX idx_mouse_time ON t_behavior_data(mouse_code, timestamp)
INDEX idx_behavior_type_time ON t_behavior_data(behavior_type_id, timestamp)
INDEX idx_mouse_physio_time ON t_physiological_state(mouse_code, timestamp)
```

## 开发计划

### 第一阶段: 数据准备 (30分钟)
- 生成测试数据
- 更新初始化脚本
- 验证数据完整性

### 第二阶段: 后端开发 (60分钟)
- 创建实体类和DTO/VO
- 实现Mapper接口和XML
- 开发Service业务逻辑
- 创建Controller接口

### 第三阶段: 前端开发 (60分钟)
- 创建页面模板
- 实现JavaScript交互
- 集成Bootstrap样式
- 添加菜单配置

### 第四阶段: 集成测试 (30分钟)
- 小鼠详情页集成
- 权限配置
- 一键部署测试
- 功能验证

## 总结

本项目将在现有小鼠管理系统基础上，新增完整的行为记录展示功能。通过双入口设计满足不同使用场景，通过汇总统计和详细列表满足数据分析需求。严格遵循现有技术架构和代码规范，确保系统的一致性和可维护性。