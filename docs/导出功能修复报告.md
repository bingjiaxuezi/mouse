# 导出功能修复报告

## 问题描述

用户反馈导出Excel功能存在问题，具体表现为：
- 传到后端的参数值为空：`TMouse(id=null, mouseCode=, mouseName=, species=, gender=, birthDate=null, weight=null, experimentId=null, photoUrl=null, status=null, createTime=null)`
- `mouseCode` 和 `mouseName` 等搜索条件没有正确传递到后端
- 搜索功能正常，但导出功能异常

## 问题分析

通过分析代码发现问题根源：

### 1. 缺少导出相关JS文件
- `mouse.html` 页面没有引入 `bootstrap-table-export-js` 相关的JavaScript文件
- 导致导出功能无法正常工作

### 2. 导出方法调用错误
- 原代码：`onclick="$.table.exportExcel()"`
- 没有传递表单ID参数，导致无法获取搜索表单的数据

### 3. 若依框架导出机制
根据 `ry-ui.js` 中的 `exportExcel` 方法分析：
```javascript
var currentId = $.common.isEmpty(formId) ? $('form').attr('id') : formId;
var dataParam = $("#" + currentId).serializeArray();
```
- 需要传递正确的表单ID才能获取表单数据
- `mouse.html` 中的搜索表单ID为 `mouse-form`

## 解决方案

### 1. 引入导出相关JS文件
在 `mouse.html` 中添加：
```html
<th:block th:include="include :: bootstrap-table-export-js" />
```

### 2. 修正导出方法调用
将导出按钮的点击事件修改为：
```html
<a class="btn btn-warning" onclick="$.table.exportExcel('mouse-form')" shiro:hasPermission="system:mouse:export">
    <i class="fa fa-download"></i> 导出
</a>
```

## 修复验证

### 1. 功能测试
- ✅ 导出功能正常响应（HTTP 200）
- ✅ 生成Excel文件成功
- ✅ 返回正确的文件下载链接

### 2. 参数传递验证
通过后端日志确认参数正确传递：
```json
{
  "mouseCode": ["TEST001"],
  "mouseName": ["测试小鼠"],
  "species": [""],
  "gender": [""],
  "status": [""],
  "params[beginTime]": [""],
  "params[endTime]": [""],
  "orderByColumn": ["createTime"],
  "isAsc": ["desc"]
}
```

### 3. 系统集成测试
- ✅ 系统正常启动
- ✅ 其他功能未受影响
- ✅ MyBatis-Plus改造后的功能正常

## 技术要点

### 1. 若依框架导出机制
- 使用 `$.table.exportExcel(formId)` 方法
- 通过 `serializeArray()` 获取表单数据
- 支持排序参数自动添加

### 2. Bootstrap Table导出插件
- 需要引入 `bootstrap-table-export.js` 和 `tableExport.min.js`
- 支持多种导出格式（Excel、CSV、JSON等）

### 3. 表单数据序列化
- 使用jQuery的 `serializeArray()` 方法
- 自动处理表单字段的名称和值
- 支持数组格式的参数传递

## 经验总结

### 1. 问题定位方法
- 通过后端日志分析参数传递情况
- 对比正常功能（搜索）和异常功能（导出）的实现差异
- 查看框架源码了解实现机制

### 2. 若依框架开发注意事项
- 导出功能需要引入相应的JS插件
- 表单操作需要传递正确的表单ID
- 遵循框架的约定和最佳实践

### 3. 前端调试技巧
- 检查JavaScript文件是否正确引入
- 验证方法调用的参数是否正确
- 通过浏览器开发者工具查看网络请求

## 后续建议

1. **代码审查**：建议对其他页面的导出功能进行检查，确保都正确引入了相关JS文件
2. **文档完善**：在开发文档中补充导出功能的实现规范
3. **测试用例**：为导出功能添加自动化测试用例
4. **错误处理**：增加前端错误提示，当导出失败时给用户明确的反馈

## 修复文件清单

- `d:\mouse\backend\ruoyi-admin\src\main\resources\templates\system\mouse\mouse.html`
  - 添加导出JS文件引用
  - 修正导出按钮的onclick事件

修复完成后，导出功能恢复正常，用户可以正常使用搜索条件进行数据导出。