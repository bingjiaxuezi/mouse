# 小鼠行为监测系统 - 系统设计文档

## 1. 系统架构概览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        小鼠行为监测系统                          │
├─────────────────────────────────────────────────────────────────┤
│  前端展示层 (Presentation Layer)                                │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │   Web管理端     │    │   移动端App     │                    │
│  │  (Vue3+Element) │    │   (uni-app)     │                    │
│  └─────────────────┘    └─────────────────┘                    │
├─────────────────────────────────────────────────────────────────┤
│  API网关层 (API Gateway)                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │           Nginx + Spring Gateway                            ││
│  │         (负载均衡、限流、认证)                                ││
│  └─────────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────────┤
│  业务服务层 (Business Service Layer)                            │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │   用户管理服务   │    │   数据分析服务   │                    │
│  │  (Spring Boot)  │    │  (Spring Boot)  │                    │
│  └─────────────────┘    └─────────────────┘                    │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │   设备管理服务   │    │   报告生成服务   │                    │
│  │  (Spring Boot)  │    │  (Spring Boot)  │                    │
│  └─────────────────┘    └─────────────────┘                    │
├─────────────────────────────────────────────────────────────────┤
│  数据采集层 (Data Collection Layer)                             │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              Python数据采集端                               ││
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          ││
│  │  │  视频采集   │ │  行为识别   │ │  数据上报   │          ││
│  │  │   模块     │ │    模块     │ │    模块     │          ││
│  │  └─────────────┘ └─────────────┘ └─────────────┘          ││
│  └─────────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────────┤
│  数据存储层 (Data Storage Layer)                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │   MySQL     │ │    Redis    │ │   MinIO     │              │
│  │  (结构化)   │ │   (缓存)    │ │  (文件)     │              │
│  └─────────────┘ └─────────────┘ └─────────────┘              │
├─────────────────────────────────────────────────────────────────┤
│  基础设施层 (Infrastructure Layer)                               │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │        监控告警 + 日志收集 + 配置中心                        ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 数据流向图

```
红外摄像头 → 视频流 → Python采集端 → 行为识别 → RESTful API → Spring Boot后端 → MySQL存储
     ↓                    ↓                              ↓
  实时监控              缓存处理                        数据分析
     ↓                    ↓                              ↓
  Web前端 ← WebSocket ← Redis消息队列 ← 异步处理 ← 统计分析服务
```

## 2. 核心模块设计

### 2.1 数据采集端 (Python)

#### 2.1.1 视频采集模块 (VideoCapture)
```python
class VideoCapture:
    """
    视频采集模块
    负责从红外摄像头获取视频流
    """
    def __init__(self, camera_id, resolution=(1920, 1080))
    def start_capture()
    def get_frame()
    def stop_capture()
    def set_night_vision_mode()
```

#### 2.1.2 目标检测模块 (MouseDetector)
```python
class MouseDetector:
    """
    小鼠检测模块
    基于YOLO进行小鼠目标检测
    """
    def __init__(self, model_path, confidence_threshold=0.5)
    def detect_mice(self, frame)
    def load_custom_model(self, model_path)
    def update_model(self, new_model_path)
```

#### 2.1.3 多目标追踪模块 (MouseTracker)
```python
class MouseTracker:
    """
    多目标追踪模块
    基于DeepSORT进行小鼠追踪
    """
    def __init__(self, max_mice=5)
    def update_tracks(self, detections)
    def get_mouse_trajectories()
    def handle_occlusion()
```

#### 2.1.4 行为识别模块 (BehaviorRecognizer)
```python
class BehaviorRecognizer:
    """
    行为识别模块
    识别睡眠、咳嗽、挠鼻等特定行为
    """
    def __init__(self)
    def recognize_sleep(self, mouse_data)
    def recognize_cough(self, mouse_data)
    def recognize_nose_scratching(self, mouse_data)
    def recognize_defecation(self, mouse_data)
    def recognize_convulsion(self, mouse_data)
```

#### 2.1.5 数据上报模块 (DataReporter)
```python
class DataReporter:
    """
    数据上报模块
    将识别结果上报到后端服务
    """
    def __init__(self, api_endpoint, api_key)
    def report_behavior_data(self, behavior_data)
    def report_heartbeat()
    def handle_network_error()
```

### 2.2 后端服务 (Spring Boot)

#### 2.2.1 设备管理服务
```java
@RestController
@RequestMapping("/api/devices")
public class DeviceController {
    // 设备注册
    @PostMapping("/register")
    public Result registerDevice(@RequestBody DeviceRegisterDTO dto)
    
    // 设备状态更新
    @PutMapping("/{deviceId}/status")
    public Result updateDeviceStatus(@PathVariable String deviceId, @RequestBody DeviceStatusDTO dto)
    
    // 获取设备列表
    @GetMapping
    public Result<List<DeviceVO>> getDeviceList()
}
```

#### 2.2.2 数据接收服务
```java
@RestController
@RequestMapping("/api/data")
public class DataController {
    // 接收行为数据
    @PostMapping("/behavior")
    public Result receiveBehaviorData(@RequestBody BehaviorDataDTO dto)
    
    // 批量接收数据
    @PostMapping("/behavior/batch")
    public Result receiveBehaviorDataBatch(@RequestBody List<BehaviorDataDTO> dtoList)
    
    // 接收心跳数据
    @PostMapping("/heartbeat")
    public Result receiveHeartbeat(@RequestBody HeartbeatDTO dto)
}
```

#### 2.2.3 数据分析服务
```java
@Service
public class DataAnalysisService {
    // 行为统计分析
    public BehaviorStatisticsVO analyzeBehaviorStatistics(AnalysisQueryDTO query)
    
    // 生成时间段报告
    public TimeRangeReportVO generateTimeRangeReport(String deviceId, LocalDateTime start, LocalDateTime end)
    
    // 对比分析
    public ComparisonReportVO generateComparisonReport(ComparisonQueryDTO query)
    
    // 异常行为检测
    public List<AbnormalBehaviorVO> detectAbnormalBehavior(String deviceId, LocalDateTime start, LocalDateTime end)
}
```

### 2.3 前端模块 (Vue 3)

#### 2.3.1 实时监控模块
- 实时视频流展示
- 设备状态监控
- 行为识别结果实时显示
- 告警信息展示

#### 2.3.2 数据分析模块
- 行为统计图表
- 时间段对比分析
- 个体行为分析
- 数据导出功能

#### 2.3.3 系统管理模块
- 用户权限管理
- 设备配置管理
- 系统参数设置
- 日志查看

## 3. 关键接口定义

### 3.1 数据上报API

#### 3.1.1 行为数据上报
```json
POST /api/data/behavior
Content-Type: application/json
Authorization: Bearer {token}

{
  "deviceId": "device_001",
  "timestamp": "2024-01-15T10:30:00Z",
  "cageId": "cage_001",
  "mouseData": [
    {
      "mouseId": "mouse_001",
      "position": {
        "x": 150.5,
        "y": 200.3
      },
      "behaviors": [
        {
          "type": "COUGH",
          "confidence": 0.85,
          "duration": 2.5,
          "startTime": "2024-01-15T10:30:00Z",
          "endTime": "2024-01-15T10:30:02.5Z"
        }
      ]
    }
  ],
  "environmentData": {
    "temperature": 22.5,
    "humidity": 60.2,
    "lightLevel": 0.1
  }
}
```

#### 3.1.2 设备心跳
```json
POST /api/data/heartbeat
Content-Type: application/json
Authorization: Bearer {token}

{
  "deviceId": "device_001",
  "timestamp": "2024-01-15T10:30:00Z",
  "status": "ONLINE",
  "cpuUsage": 45.2,
  "memoryUsage": 60.8,
  "diskUsage": 30.5,
  "cameraStatus": "NORMAL",
  "lastFrameTime": "2024-01-15T10:29:58Z"
}
```

### 3.2 数据查询API

#### 3.2.1 行为统计查询
```json
GET /api/analysis/behavior-statistics
Authorization: Bearer {token}

Query Parameters:
- deviceId: string (required)
- startTime: datetime (required)
- endTime: datetime (required)
- behaviorTypes: array[string] (optional)
- mouseIds: array[string] (optional)

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "totalCount": 150,
    "behaviorCounts": {
      "COUGH": 45,
      "NOSE_SCRATCH": 32,
      "SLEEP": 73
    },
    "mouseStatistics": [
      {
        "mouseId": "mouse_001",
        "behaviorCounts": {
          "COUGH": 12,
          "NOSE_SCRATCH": 8,
          "SLEEP": 15
        }
      }
    ],
    "timeDistribution": [
      {
        "hour": 0,
        "count": 8
      }
    ]
  }
}
```

### 3.3 WebSocket实时推送

#### 3.3.1 实时行为推送
```json
// WebSocket连接: ws://localhost:8080/ws/realtime
// 消息格式:
{
  "type": "BEHAVIOR_DETECTED",
  "data": {
    "deviceId": "device_001",
    "mouseId": "mouse_001",
    "behavior": {
      "type": "COUGH",
      "confidence": 0.85,
      "timestamp": "2024-01-15T10:30:00Z"
    }
  }
}
```

## 4. 数据库设计

### 4.1 核心表结构

#### 4.1.1 设备表 (t_device)
```sql
CREATE TABLE t_device (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    device_id VARCHAR(50) UNIQUE NOT NULL COMMENT '设备ID',
    device_name VARCHAR(100) NOT NULL COMMENT '设备名称',
    location VARCHAR(200) COMMENT '设备位置',
    status ENUM('ONLINE', 'OFFLINE', 'ERROR') DEFAULT 'OFFLINE',
    last_heartbeat DATETIME COMMENT '最后心跳时间',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 4.1.2 鼠笼表 (t_cage)
```sql
CREATE TABLE t_cage (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    cage_id VARCHAR(50) UNIQUE NOT NULL COMMENT '鼠笼ID',
    device_id VARCHAR(50) NOT NULL COMMENT '关联设备ID',
    cage_name VARCHAR(100) NOT NULL COMMENT '鼠笼名称',
    mouse_count INT DEFAULT 0 COMMENT '小鼠数量',
    experiment_group VARCHAR(100) COMMENT '实验组别',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (device_id) REFERENCES t_device(device_id)
);
```

#### 4.1.3 小鼠表 (t_mouse)
```sql
CREATE TABLE t_mouse (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    mouse_id VARCHAR(50) UNIQUE NOT NULL COMMENT '小鼠ID',
    cage_id VARCHAR(50) NOT NULL COMMENT '所属鼠笼',
    mouse_name VARCHAR(100) COMMENT '小鼠名称',
    gender ENUM('MALE', 'FEMALE') COMMENT '性别',
    age_weeks INT COMMENT '周龄',
    weight_grams DECIMAL(6,2) COMMENT '体重(克)',
    strain VARCHAR(50) COMMENT '品系',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (cage_id) REFERENCES t_cage(cage_id)
);
```

#### 4.1.4 行为数据表 (t_behavior_data)
```sql
CREATE TABLE t_behavior_data (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    device_id VARCHAR(50) NOT NULL COMMENT '设备ID',
    mouse_id VARCHAR(50) NOT NULL COMMENT '小鼠ID',
    behavior_type ENUM('SLEEP', 'COUGH', 'NOSE_SCRATCH', 'DEFECATION', 'CONVULSION', 'MOVEMENT') NOT NULL,
    confidence DECIMAL(4,3) NOT NULL COMMENT '置信度',
    duration_seconds DECIMAL(8,3) COMMENT '持续时间(秒)',
    position_x DECIMAL(8,3) COMMENT 'X坐标',
    position_y DECIMAL(8,3) COMMENT 'Y坐标',
    start_time DATETIME NOT NULL COMMENT '开始时间',
    end_time DATETIME COMMENT '结束时间',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_device_time (device_id, start_time),
    INDEX idx_mouse_behavior (mouse_id, behavior_type),
    INDEX idx_time_range (start_time, end_time)
);
```

## 5. 部署架构

### 5.1 单机部署
```
┌─────────────────────────────────────┐
│           服务器 (Linux)             │
│  ┌─────────────┐  ┌─────────────┐   │
│  │   Nginx     │  │   Python    │   │
│  │  (前端)     │  │  (采集端)   │   │
│  └─────────────┘  └─────────────┘   │
│  ┌─────────────┐  ┌─────────────┐   │
│  │Spring Boot  │  │   MySQL     │   │
│  │  (后端)     │  │  (数据库)   │   │
│  └─────────────┘  └─────────────┘   │
│  ┌─────────────┐  ┌─────────────┐   │
│  │   Redis     │  │   MinIO     │   │
│  │  (缓存)     │  │  (文件)     │   │
│  └─────────────┘  └─────────────┘   │
└─────────────────────────────────────┘
```

### 5.2 分布式部署
```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  前端服务器  │  │  应用服务器  │  │  数据库服务器│
│             │  │             │  │             │
│   Nginx     │  │Spring Boot  │  │   MySQL     │
│   Vue App   │  │   Redis     │  │   Redis     │
│             │  │   MinIO     │  │   Backup    │
└─────────────┘  └─────────────┘  └─────────────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  采集端1    │  │  采集端2    │  │  采集端N    │
│             │  │             │  │             │
│  Python     │  │  Python     │  │  Python     │
│  Camera     │  │  Camera     │  │  Camera     │
│  GPU        │  │  GPU        │  │  GPU        │
└─────────────┘  └─────────────┘  └─────────────┘
```

## 6. 性能指标

### 6.1 系统性能要求
- **视频处理**: 30fps实时处理
- **检测延迟**: <100ms
- **识别精度**: >90%
- **并发支持**: 10个设备同时接入
- **数据存储**: 支持TB级数据存储

### 6.2 硬件配置建议

#### 采集端:
- **CPU**: Intel i7或AMD Ryzen 7以上
- **GPU**: NVIDIA GTX 1660或以上(支持CUDA)
- **内存**: 16GB以上
- **存储**: 500GB SSD

#### 服务端:
- **CPU**: Intel Xeon或AMD EPYC
- **内存**: 32GB以上
- **存储**: 2TB SSD + 10TB HDD
- **网络**: 千兆以太网

## 7. 安全设计

### 7.1 认证授权
- JWT Token认证
- RBAC权限控制
- API访问限流
- 数据传输加密(HTTPS/WSS)

### 7.2 数据安全
- 数据库访问控制
- 敏感数据加密存储
- 操作日志记录
- 定期数据备份

### 7.3 网络安全
- 防火墙配置
- VPN访问控制
- 入侵检测
- 安全漏洞扫描