# 计算机视觉小鼠管理系统 - 系统设计文档

## 1. 系统架构概览

### 1.1 系统核心特色

本系统是一套基于计算机视觉技术的智能化小鼠管理系统，采用创新的"实验驱动"设计架构，核心特色包括：
- **实验驱动架构**：以实验项目为起点，通过实验专属二维码实现笼子与实验的直接绑定
- **智能绑定机制**：摄像头系统自动识别实验二维码，实现笼子与实验的无缝绑定
- **计算机视觉识别**：基于深度学习的小鼠自动识别和行为分析
- **全流程自动化**：从实验创建到数据分析的完整自动化流程
- **实时智能监控**：毫秒级的实时数据处理和异常预警
- **移动端支持**：通过扫描实验二维码，支持移动端查看和操作
- **专业数据分析**：面向科研需求的深度数据挖掘和统计分析

### 1.2 当前实现状态

**已完成模块：**
- ✅ 后端服务框架 (Spring Boot + 若依框架)
- ✅ 数据库设计 (MySQL)
- ✅ 缓存系统 (Redis)
- ✅ 文件存储 (MinIO)
- ✅ Docker容器化部署
- ✅ 自动化部署脚本
- ✅ RESTful API接口规范
- ✅ 用户权限管理系统
- ✅ 系统日志和审计功能

**开发中模块：**
- 🔄 前端Vue.js界面开发
- 🔄 Excel数据导出功能
- 🔄 系统性能优化
- 🔄 API接口完善

**待开发模块：**
- ⏳ 计算机视觉识别引擎 (Python + OpenCV + PyTorch)
- ⏳ 二维码管理系统
- ⏳ 实时数据采集端
- ⏳ 智能行为分析算法
- ⏳ 实时监控界面
- ⏳ 智能报表生成系统
- ⏳ 移动端应用 (可选)

### 1.3 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                 计算机视觉小鼠管理系统 v1.0                      │
├─────────────────────────────────────────────────────────────────┤
│  前端展示层 (Presentation Layer) - 待开发                       │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │   Web管理端     │    │   移动端App     │                    │
│  │  (Vue3+Element) │    │   (uni-app)     │                    │
│  │ • 笼子管理界面  │    │ • 二维码扫描    │                    │
│  │ • 实时监控界面  │    │ • 快速激活笼子  │                    │
│  │ • 数据分析界面  │    │ • 状态查看      │                    │
│  └─────────────────┘    └─────────────────┘                    │
├─────────────────────────────────────────────────────────────────┤
│  业务服务层 (Business Service Layer) - 已完成                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              Spring Boot 后端服务                          ││
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          ││
│  │  │  二维码管理 │ │  视觉识别   │ │  数据管理   │          ││
│  │  │   模块     │ │    模块     │ │    模块     │          ││
│  │  │ • 笼子注册  │ │ • 图像处理  │ │ • 行为分析  │          ││
│  │  │ • 激活管理  │ │ • 目标检测  │ │ • 统计报表  │          ││
│  │  └─────────────┘ └─────────────┘ └─────────────┘          ││
│  └─────────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────────┤
│  计算机视觉层 (Computer Vision Layer) - 待开发                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              Python AI识别引擎                              ││
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          ││
│  │  │  视频采集   │ │  深度学习   │ │  行为识别   │          ││
│  │  │   模块     │ │   识别模块  │ │    模块     │          ││
│  │  │ • 高清摄像  │ │ • YOLO检测  │ • 睡眠识别   │          ││
│  │  │ • 实时流处理│ │ • 目标跟踪  │ • 咳嗽识别   │          ││
│  │  └─────────────┘ └─────────────┘ └─────────────┘          ││
│  └─────────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────────┤
│  数据存储层 (Data Storage Layer) - 已完成                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │   MySQL     │ │    Redis    │ │   MinIO     │              │
│  │ • 笼子档案  │ │ • 实时缓存  │ │ • 视频文件  │              │
│  │ • 小鼠信息  │ │ • 会话管理  │ │ • 图像数据  │              │
│  │ • 行为数据  │ │ • 计算结果  │ │ • 分析报告  │              │
│  └─────────────┘ └─────────────┘ └─────────────┘              │
├─────────────────────────────────────────────────────────────────┤
│  基础设施层 (Infrastructure Layer) - 已完成                     │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │        Docker容器化 + 自动化部署脚本                        ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 实验驱动数据流向图

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  创建实验   │────▶│ 生成实验码  │────▶│  实验信息   │
│  (Web端)    │     │  (后端API)  │     │  (数据库)   │
└─────────────┘     └─────────────┘     └─────────────┘
       │                    │                    │
       ▼                    ▼                    ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 扫描实验码  │────▶│  笼子绑定   │────▶│  绑定关系   │
│ (摄像头/移动)│     │  (自动绑定) │     │  (数据库)   │
└─────────────┘     └─────────────┘     └─────────────┘
       │                    │                    │
       ▼                    ▼                    ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  添加小鼠   │────▶│ 自动识别上报│────▶│  小鼠信息   │
│  (人工操作) │     │ (AI识别)    │     │  (数据库)   │
└─────────────┘     └─────────────┘     └─────────────┘
       │                    │                    │
       ▼                    ▼                    ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 一键启动    │────▶│  实时监控   │────▶│  行为数据   │
│ (就绪检查)  │     │ (AI分析)    │     │  (实时存储) │
└─────────────┘     └─────────────┘     └─────────────┘
       │                    │                    │
       ▼                    ▼                    ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   高清摄像  │────▶│ AI视觉识别  │────▶│  行为数据   │
│  (视频流)   │     │ (深度学习)  │     │  (实时存储) │
└─────────────┘     └─────────────┘     └─────────────┘
       │                    │                    │
       │                    │                    ▼
       │                    │            ┌─────────────┐
       │                    │            │   MySQL     │
       │                    │            │ • 笼子档案  │
       │                    │            │ • 小鼠信息  │
       │                    │            │ • 行为记录  │
       │                    │            └─────────────┘
       │                    │                    │
       │                    ▼                    │
       │            ┌─────────────┐              │
       │            │    Redis    │              │
       │            │ • 实时缓存  │              │
       │            │ • 计算结果  │              │
       │            │ • 会话管理  │              │
       │            └─────────────┘              │
       │                    │                    │
       ▼                    │                    │
┌─────────────┐             │                    │
│   MinIO     │             │                    │
│ • 视频文件  │             │                    │
│ • 图像数据  │             │                    │
│ • 分析报告  │             │                    │
└─────────────┘             │                    │
       │                    │                    │
       └────────────────────┼────────────────────┘
                            │
                            ▼
                    ┌─────────────┐
                    │ Spring Boot │
                    │ • RESTful API│
                    │ • WebSocket │
                    │ • 实时推送  │
                    └─────────────┘
                            │
                            ▼
                    ┌─────────────┐
                    │   Vue.js    │
                    │ • 实时监控  │
                    │ • 数据分析  │
                    │ • 报表生成  │
                    └─────────────┘
```

## 2. 核心模块设计

### 2.1 后端服务 (Spring Boot) - 已完成

#### 2.1.1 实验驱动管理模块

**实验管理 (ExperimentController)**
```java
@RestController
@RequestMapping("/experiment")
public class ExperimentController {
    
    @PostMapping("/create")
    public AjaxResult createExperiment(@RequestBody ExperimentCreateDto dto) {
        // 创建实验项目，生成实验专属二维码
        // 返回实验ID和二维码图片
    }
    
    @PostMapping("/bind-cage")
    public AjaxResult bindCage(@RequestBody CageBindDto dto) {
        // 通过扫描实验二维码自动绑定笼子
        // 建立实验与笼子的关联关系
    }
    
    @PostMapping("/add-mouse")
    public AjaxResult addMouse(@RequestBody MouseAddDto dto) {
        // 向绑定的笼子添加小鼠
        // 自动上报小鼠信息到实验系统
    }
    
    @PostMapping("/start/{experimentId}")
    public AjaxResult startExperiment(@PathVariable String experimentId) {
        // 一键启动实验（自动检查就绪状态）
        // 启动所有关联笼子的监控
    }
    
    @GetMapping("/status/{experimentId}")
    public AjaxResult getExperimentStatus(@PathVariable String experimentId) {
        // 获取实验实时状态和进度
        // 包括笼子状态、小鼠状态、数据采集状态
    }
    
    @GetMapping("/list")
    public TableDataInfo getExperimentList(ExperimentQueryDto query) {
        // 获取实验列表，支持筛选
    }
}```

**笼子管理 (CageController)**
```java
@RestController
@RequestMapping("/cage")
public class CageController {
    
    @GetMapping("/scan-qr/{qrCode}")
    public AjaxResult scanExperimentQR(@PathVariable String qrCode) {
        // 扫描实验二维码，获取实验信息
        // 支持摄像头和移动端扫码
    }
    
    @GetMapping("/status/{cageId}")
    public AjaxResult getCageStatus(@PathVariable String cageId) {
        // 获取笼子实时状态
        // 包括绑定的实验、小鼠状态、设备状态
    }
    
    @GetMapping("/experiment-info/{cageId}")
    public AjaxResult getExperimentInfo(@PathVariable String cageId) {
        // 通过笼子ID获取关联的实验信息
        // 支持移动端查看实验详情
    }
}```

**小鼠管理 (MouseController)**
```java
@RestController
@RequestMapping("/mouse")
public class MouseController {
    
    @PostMapping("/bind")
    public AjaxResult bindMouse(@RequestBody MouseBindDto dto) {
        // 将小鼠绑定到笼子
        // 记录小鼠基本信息和实验参数
    }
    
    @GetMapping("/info/{mouseId}")
    public AjaxResult getMouseInfo(@PathVariable String mouseId) {
        // 获取小鼠详细信息和历史数据
    }
    
    @PutMapping("/update")
    public AjaxResult updateMouse(@RequestBody MouseUpdateDto dto) {
        // 更新小鼠信息
    }
}
```

#### 2.1.2 系统管理模块

**用户管理：**
- 用户注册、登录、权限管理
- 角色分配和权限控制
- 用户信息维护

**系统配置：**
- 系统参数配置
- 字典数据管理
- 菜单权限管理

**日志管理：**
- 操作日志记录
- 登录日志追踪
- 系统异常日志

#### 2.1.3 数据管理模块 (已完成)

**数据存储服务：**
- MySQL: 笼子档案、小鼠信息、行为数据
- Redis: 实时缓存、会话管理、计算结果
- MinIO: 视频文件、图像数据、分析报告

**数据导出服务：**
- Excel报表导出 (支持多种模板)
- PDF报告生成 (包含图表和统计)
- 实时数据统计和分析

**API接口服务：**
- RESTful API设计
- WebSocket实时推送
- 统一响应格式和错误处理

#### 2.1.4 计算机视觉服务接口 (待开发)

**视觉识别接口 (VisionController)**
```java
@RestController
@RequestMapping("/vision")
public class VisionController {
    
    @PostMapping("/start-monitor/{cageId}")
    public AjaxResult startMonitoring(@PathVariable String cageId) {
        // 启动指定笼子的视觉监控
        // 通知Python端开始采集和识别
    }
    
    @PostMapping("/stop-monitor/{cageId}")
    public AjaxResult stopMonitoring(@PathVariable String cageId) {
        // 停止指定笼子的监控
    }
    
    @PostMapping("/behavior-data")
    public AjaxResult receiveBehaviorData(@RequestBody BehaviorDataDto data) {
        // 接收Python端上报的行为数据
        // 实时存储和推送给前端
    }
    
    @GetMapping("/real-time/{cageId}")
    public AjaxResult getRealTimeData(@PathVariable String cageId) {
        // 获取实时监控数据
    }
}
```

### 2.2 计算机视觉识别引擎 (Python) - 待开发

#### 2.2.1 视频采集模块 (VideoCapture)
```python
class VideoCapture:
    """
    视频采集模块
    负责从红外摄像头获取高清视频流
    """
    def __init__(self, camera_id, cage_id, resolution=(1920, 1080)):
        self.camera_id = camera_id
        self.cage_id = cage_id
        self.resolution = resolution
        self.cap = None
        self.is_recording = False
        
    def start_capture(self):
        """开始视频采集，支持多路并发"""
        pass
        
    def get_frame(self):
        """获取高清帧图像，预处理优化"""
        pass
        
    def save_video_segment(self, duration=60):
        """保存视频片段到MinIO"""
        pass
        
    def stop_capture(self):
        """停止采集，清理资源"""
        pass
```

#### 2.2.2 深度学习检测模块 (MouseDetector)
```python
class MouseDetector:
    """
    小鼠检测模块
    基于YOLO进行高精度小鼠目标检测
    """
    def __init__(self, model_path="models/yolo_mouse.pt"):
        self.model = self.load_yolo_model(model_path)
        self.confidence_threshold = 0.7
        
    def detect_mice(self, frame):
        """使用YOLO检测小鼠位置和数量"""
        pass
        
    def extract_features(self, detection_box, frame):
        """提取小鼠特征用于行为分析"""
        pass
        
    def load_yolo_model(self, model_path):
        """加载训练好的YOLO模型"""
        pass
```

#### 2.2.3 多目标追踪模块 (MouseTracker)
```python
class MouseTracker:
    """
    多目标追踪模块
    基于DeepSORT进行小鼠追踪，保持ID一致性
    """
    def __init__(self, max_disappeared=30):
        self.trackers = {}
        self.max_disappeared = max_disappeared
        self.next_id = 0
        
    def update_tracks(self, detections):
        """更新多目标追踪，保持ID一致性"""
        pass
        
    def get_mouse_trajectories(self):
        """获取小鼠运动轨迹"""
        pass
        
    def calculate_movement_metrics(self, mouse_id):
        """计算运动指标：速度、距离、活跃度"""
        pass
```

#### 2.2.4 智能行为识别模块 (BehaviorRecognizer)
```python
class BehaviorRecognizer:
    """
    行为识别模块
    识别睡眠、咳嗽、挠鼻等特定行为模式
    """
    def __init__(self, model_path="models/behavior_classifier.pt"):
        self.model = self.load_behavior_model(model_path)
        self.behavior_types = ['sleeping', 'eating', 'drinking', 'grooming', 'exploring']
        
    def recognize_behavior(self, track_sequence):
        """基于时序数据识别行为模式"""
        pass
        
    def detect_abnormal_behavior(self, behavior_history):
        """检测异常行为模式"""
        pass
        
    def generate_behavior_statistics(self, cage_id, time_range):
        """生成行为统计报告"""
        pass
```

#### 2.2.5 实时数据上报模块 (DataReporter)
```python
class DataReporter:
    """
    数据上报模块
    将识别结果实时上报到后端服务
    """
    def __init__(self, server_url, cage_id):
        self.server_url = server_url
        self.cage_id = cage_id
        self.websocket = None
        
    def report_real_time_data(self, behavior_data):
        """实时上报行为数据到后端"""
        pass
        
    def upload_video_segment(self, video_path):
        """上传视频片段到MinIO"""
        pass
        
    def send_heartbeat(self):
        """发送设备心跳，确保连接状态"""
        pass
        
    def handle_server_commands(self, command):
        """处理服务端控制命令"""
        pass
```

### 2.4 后端服务 (Spring Boot) - 已完成

#### 2.2.1 系统管理接口
```java
@RestController
@RequestMapping("/system")
public class SystemController {
    // 用户管理
    @GetMapping("/user/list")
    public TableDataInfo list(SysUser user)
    
    @PostMapping("/user")
    public AjaxResult add(@RequestBody SysUser user)
    
    @PutMapping("/user")
    public AjaxResult edit(@RequestBody SysUser user)
    
    @DeleteMapping("/user/{userIds}")
    public AjaxResult remove(@PathVariable Long[] userIds)
}
```

#### 2.2.2 数据导出接口
```java
@RestController
@RequestMapping("/export")
public class ExportController {
    // Excel导出
    @PostMapping("/excel")
    public void export(HttpServletResponse response, @RequestBody ExportRequest request)
    
    // 数据查询
    @GetMapping("/data")
    public TableDataInfo getData(@RequestParam Map<String, Object> params)
    
    // 模板下载
    @GetMapping("/template/{templateName}")
    public void downloadTemplate(@PathVariable String templateName, HttpServletResponse response)
}
```

#### 2.2.3 文件管理服务
```java
@Service
public class FileService {
    // MinIO文件上传
    public String uploadFile(MultipartFile file, String bucketName)
    
    // 文件下载
    public InputStream downloadFile(String fileName, String bucketName)
    
    // 文件删除
    public boolean deleteFile(String fileName, String bucketName)
    
    // 获取文件访问URL
    public String getFileUrl(String fileName, String bucketName)
}
```

#### 2.2.4 待开发接口（预留）
```java
// 设备管理接口（待开发）
@RestController
@RequestMapping("/api/devices")
public class DeviceController {
    // 设备注册
    @PostMapping("/register")
    public Result registerDevice(@RequestBody DeviceRegisterDTO dto)
    
    // 设备状态更新
    @PutMapping("/{deviceId}/status")
    public Result updateDeviceStatus(@PathVariable String deviceId, @RequestBody DeviceStatusDTO dto)
    
    // 获取设备列表
    @GetMapping
    public Result<List<DeviceVO>> getDeviceList()
}

// 数据接收接口（待开发）
@RestController
@RequestMapping("/api/data")
public class DataController {
    // 接收行为数据
    @PostMapping("/behavior")
    public Result receiveBehaviorData(@RequestBody BehaviorDataDTO dto)
    
    // 批量接收数据
    @PostMapping("/behavior/batch")
    public Result receiveBehaviorDataBatch(@RequestBody List<BehaviorDataDTO> dtoList)
    
    // 接收心跳数据
    @PostMapping("/heartbeat")
    public Result receiveHeartbeat(@RequestBody HeartbeatDTO dto)
}
```

### 2.3 前端模块 (Vue 3) - 开发中

#### 2.3.1 技术选型

**前端框架：**
- Vue 3 - 主框架 (Composition API)
- Element Plus - UI组件库
- Vue Router - 路由管理
- Pinia - 状态管理
- Axios - HTTP客户端
- Socket.io - WebSocket实时通信
- ECharts - 数据可视化
- QRCode.js - 二维码生成

**开发工具：**
- Vite - 构建工具
- TypeScript - 类型支持
- ESLint - 代码检查
- Prettier - 代码格式化

#### 2.3.2 页面结构设计

**已完成页面：**
- ✅ 登录页面 - 用户身份认证
- ✅ 首页仪表板 - 系统概览
- ✅ 用户管理 - 用户信息维护
- ✅ 角色管理 - 权限角色配置
- ✅ 菜单管理 - 系统菜单配置
- ✅ 数据导出 - Excel导出功能
- ✅ 系统监控 - 系统状态监控
- ✅ 操作日志 - 用户操作记录

**开发中页面：**
- 🔄 笼子管理 - 二维码笼子注册和激活
- 🔄 实时监控 - 视频流监控和行为识别
- 🔄 数据分析 - 行为数据统计分析

**待开发页面：**
- ⏳ 小鼠档案管理 - 小鼠信息和健康档案
- ⏳ 实验项目管理 - 实验设计和进度跟踪
- ⏳ 智能报告生成 - AI驱动的分析报告
- ⏳ 视觉识别配置 - AI模型参数调优
- ⏳ 移动端应用 - 二维码扫描和快速操作

#### 2.3.3 核心组件设计

**二维码管理组件 (QRCodeManager.vue)**
```vue
<template>
  <div class="qr-code-manager">
    <!-- 二维码生成 -->
    <el-card class="qr-generator">
      <h3>笼子注册</h3>
      <el-form :model="cageForm" @submit="generateQRCode">
        <el-form-item label="笼子编号">
          <el-input v-model="cageForm.cageId" placeholder="自动生成或手动输入" />
        </el-form-item>
        <el-form-item label="实验项目">
          <el-select v-model="cageForm.experimentId">
            <el-option v-for="exp in experiments" :key="exp.id" :label="exp.name" :value="exp.id" />
          </el-select>
        </el-form-item>
        <el-button type="primary" @click="generateQRCode">生成二维码</el-button>
      </el-form>
    </el-card>
    
    <!-- 二维码显示 -->
    <el-card class="qr-display" v-if="qrCodeUrl">
      <div class="qr-code">
        <canvas ref="qrCanvas"></canvas>
      </div>
      <el-button @click="printQRCode">打印二维码</el-button>
    </el-card>
  </div>
</template>
```

**实时监控组件 (RealTimeMonitor.vue)**
```vue
<template>
  <div class="real-time-monitor">
    <!-- 视频流显示 -->
    <div class="video-grid">
      <div v-for="cage in activeCages" :key="cage.id" class="video-item">
        <video :src="cage.videoStream" autoplay muted></video>
        <div class="overlay-info">
          <span class="cage-id">{{ cage.id }}</span>
          <span class="mouse-count">小鼠数量: {{ cage.mouseCount }}</span>
          <span class="status" :class="cage.status">{{ cage.statusText }}</span>
        </div>
      </div>
    </div>
    
    <!-- 实时数据面板 -->
    <el-card class="data-panel">
      <h3>实时行为数据</h3>
      <div class="behavior-stats">
        <div v-for="behavior in behaviorStats" :key="behavior.type" class="stat-item">
          <span class="behavior-name">{{ behavior.name }}</span>
          <el-progress :percentage="behavior.percentage" :color="behavior.color" />
        </div>
      </div>
    </el-card>
  </div>
</template>
```

**智能数据分析组件 (DataAnalysis.vue)**
```vue
<template>
  <div class="data-analysis">
    <!-- 筛选条件 -->
    <el-card class="filter-panel">
      <el-form :model="filterForm" inline>
        <el-form-item label="时间范围">
          <el-date-picker v-model="filterForm.dateRange" type="datetimerange" />
        </el-form-item>
        <el-form-item label="笼子">
          <el-select v-model="filterForm.cageIds" multiple>
            <el-option v-for="cage in cages" :key="cage.id" :label="cage.name" :value="cage.id" />
          </el-select>
        </el-form-item>
        <el-form-item label="行为类型">
          <el-select v-model="filterForm.behaviorTypes" multiple>
            <el-option v-for="type in behaviorTypes" :key="type" :label="type" :value="type" />
          </el-select>
        </el-form-item>
        <el-button type="primary" @click="analyzeData">分析数据</el-button>
      </el-form>
    </el-card>
    
    <!-- 图表展示 -->
    <div class="charts-container">
      <el-card class="chart-item">
        <h4>行为时间分布</h4>
        <div ref="behaviorTimeChart" class="chart"></div>
      </el-card>
      <el-card class="chart-item">
        <h4>活跃度趋势</h4>
        <div ref="activityTrendChart" class="chart"></div>
      </el-card>
    </div>
  </div>
</template>
```

## 3. 关键接口定义

### 3.1 当前已实现接口

#### 3.1.1 用户管理接口

**用户登录：** `POST /login`
```json
// 请求参数
{
  "username": "admin",
  "password": "admin123",
  "code": "1234",
  "uuid": "uuid-string"
}

// 响应格式
{
  "code": 200,
  "msg": "操作成功",
  "token": "eyJhbGciOiJIUzUxMiJ9..."
}
```

**获取用户信息：** `GET /getInfo`
```json
// 响应格式
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "user": {
      "userId": 1,
      "userName": "admin",
      "nickName": "管理员"
    },
    "roles": ["admin"],
    "permissions": ["*:*:*"]
  }
}
```

#### 3.1.2 二维码笼子管理接口

**笼子注册：** `POST /api/cage/register`
```json
// 请求参数
{
  "cageId": "CAGE_001",
  "experimentId": 1,
  "location": "实验室A-架子1-层2",
  "capacity": 5,
  "description": "雄性小鼠笼子"
}

// 响应格式
{
  "code": 200,
  "msg": "笼子注册成功",
  "data": {
    "id": 1,
    "cageId": "CAGE_001",
    "qrCode": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
    "status": "REGISTERED",
    "createTime": "2024-01-15 10:30:00"
  }
}
```

**笼子激活：** `POST /api/cage/activate`
```json
// 请求参数
{
  "cageId": "CAGE_001",
  "deviceId": "CAM_001"
}

// 响应格式
{
  "code": 200,
  "msg": "笼子激活成功",
  "data": {
    "cageId": "CAGE_001",
    "status": "ACTIVE",
    "deviceId": "CAM_001",
    "activateTime": "2024-01-15 10:30:00"
  }
}
```

**获取笼子状态：** `GET /api/cage/status/{cageId}`
```json
// 响应格式
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "cageId": "CAGE_001",
    "status": "ACTIVE",
    "mouseCount": 3,
    "lastActivity": "2024-01-15 15:30:00",
    "deviceId": "CAM_001",
    "videoStream": "ws://localhost:8080/video/CAGE_001",
    "experiment": {
      "id": 1,
      "name": "行为学实验A",
      "startDate": "2024-01-01"
    }
  }
}
```

#### 3.1.3 系统管理接口

**获取用户列表：** `GET /system/user/list`
```json
// 响应格式
{
  "code": 200,
  "msg": "查询成功",
  "rows": [
    {
      "userId": 1,
      "userName": "admin",
      "nickName": "管理员",
      "email": "admin@example.com",
      "status": "0",
      "createTime": "2024-01-15 10:30:00"
    }
  ],
  "total": 1
}
```

**数据导出接口：** `POST /export/excel`
```json
// 请求参数
{
  "type": "behavior_data",
  "format": "excel",
  "conditions": {
    "cageIds": ["CAGE_001", "CAGE_002"],
    "startDate": "2024-01-01",
    "endDate": "2024-01-31",
    "behaviorTypes": ["EATING", "DRINKING", "RUNNING"]
  }
}

// 响应格式
{
  "code": 200,
  "msg": "导出成功",
  "data": {
    "downloadUrl": "/api/files/download/behavior_data_20240115.xlsx",
    "fileName": "行为数据_20240115.xlsx",
    "recordCount": 15420
  }
}
```

### 3.2 待开发接口（预留设计）

#### 3.2.1 计算机视觉服务接口

**启动监控：** `POST /api/vision/start`
```json
// 请求参数
{
  "cageId": "CAGE_001",
  "deviceId": "CAM_001",
  "config": {
    "detectionThreshold": 0.8,
    "trackingEnabled": true,
    "behaviorTypes": ["EATING", "DRINKING", "RUNNING", "SLEEPING"]
  }
}

// 响应格式
{
  "code": 200,
  "msg": "监控启动成功",
  "data": {
    "sessionId": "session_001",
    "status": "RUNNING",
    "startTime": "2024-01-15T10:30:00Z"
  }
}
```

**停止监控：** `POST /api/vision/stop`
```json
// 请求参数
{
  "sessionId": "session_001",
  "cageId": "CAGE_001"
}

// 响应格式
{
  "code": 200,
  "msg": "监控停止成功",
  "data": {
    "sessionId": "session_001",
    "status": "STOPPED",
    "stopTime": "2024-01-15T12:30:00Z",
    "duration": 7200
  }
}
```

**获取实时数据：** `GET /api/vision/realtime/{cageId}`
```json
// 响应格式
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "cageId": "CAGE_001",
    "timestamp": "2024-01-15T10:30:00Z",
    "mouseCount": 3,
    "currentBehaviors": [
      {
        "mouseId": "mouse_001",
        "behavior": "EATING",
        "confidence": 0.92,
        "position": {"x": 150, "y": 200}
      }
    ],
    "environmentData": {
      "temperature": 22.5,
      "humidity": 60.2
    }
  }
}
```

#### 3.2.2 数据采集接口

**行为数据上报：** `POST /api/data/behavior`
```json
{
  "deviceId": "device_001",
  "timestamp": "2024-01-15T10:30:00Z",
  "cageId": "cage_001",
  "mouseData": [
    {
      "mouseId": "mouse_001",
      "position": {
        "x": 150.5,
        "y": 200.3
      },
      "behaviors": [
        {
          "type": "COUGH",
          "confidence": 0.85,
          "duration": 2.5,
          "startTime": "2024-01-15T10:30:00Z",
          "endTime": "2024-01-15T10:30:02.5Z"
        }
      ]
    }
  ],
  "environmentData": {
    "temperature": 22.5,
    "humidity": 60.2,
    "lightLevel": 0.1
  }
}
```

### 3.2 数据查询API

#### 3.2.1 行为统计查询
```json
GET /api/analysis/behavior-statistics
Authorization: Bearer {token}

Query Parameters:
- deviceId: string (required)
- startTime: datetime (required)
- endTime: datetime (required)
- behaviorTypes: array[string] (optional)
- mouseIds: array[string] (optional)

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "totalCount": 150,
    "behaviorCounts": {
      "COUGH": 45,
      "NOSE_SCRATCH": 32,
      "SLEEP": 73
    },
    "mouseStatistics": [
      {
        "mouseId": "mouse_001",
        "behaviorCounts": {
          "COUGH": 12,
          "NOSE_SCRATCH": 8,
          "SLEEP": 15
        }
      }
    ],
    "timeDistribution": [
      {
        "hour": 0,
        "count": 8
      }
    ]
  }
}
```

### 3.3 WebSocket实时推送

#### 3.3.1 实时行为推送
```json
// WebSocket连接: ws://localhost:8080/ws/realtime
// 消息格式:
{
  "type": "BEHAVIOR_DETECTED",
  "data": {
    "deviceId": "device_001",
    "mouseId": "mouse_001",
    "behavior": {
      "type": "COUGH",
      "confidence": 0.85,
      "timestamp": "2024-01-15T10:30:00Z"
    }
  }
}
```

## 4. 数据库设计

### 4.1 核心表结构

#### 4.1.1 设备表 (t_device)
```sql
CREATE TABLE t_device (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    device_id VARCHAR(50) UNIQUE NOT NULL COMMENT '设备ID',
    device_name VARCHAR(100) NOT NULL COMMENT '设备名称',
    device_type VARCHAR(50) DEFAULT 'CAMERA' COMMENT '设备类型',
    location VARCHAR(200) COMMENT '设备位置',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    port INT COMMENT '端口号',
    status VARCHAR(20) DEFAULT 'OFFLINE' COMMENT '设备状态:ONLINE,OFFLINE,ERROR,MAINTENANCE',
    last_heartbeat DATETIME COMMENT '最后心跳时间',
    hardware_info JSON COMMENT '硬件信息',
    config_info JSON COMMENT '配置信息',
    created_by BIGINT COMMENT '创建人ID',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted TINYINT DEFAULT 0 COMMENT '是否删除:0-否,1-是',
    INDEX idx_device_id (device_id),
    INDEX idx_status (status),
    INDEX idx_created_time (created_time)
);
```

#### 4.1.2 鼠笼表 (t_cage)
```sql
CREATE TABLE t_cage (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    cage_id VARCHAR(50) UNIQUE NOT NULL COMMENT '鼠笼ID',
    qr_code TEXT COMMENT '二维码内容(Base64编码)',
    qr_code_url VARCHAR(500) COMMENT '二维码图片URL',
    device_id VARCHAR(50) COMMENT '关联设备ID',
    cage_name VARCHAR(100) NOT NULL COMMENT '鼠笼名称',
    location VARCHAR(200) COMMENT '笼子位置(实验室-架子-层)',
    capacity INT DEFAULT 5 COMMENT '笼子容量',
    mouse_count INT DEFAULT 0 COMMENT '当前小鼠数量',
    experiment_id BIGINT COMMENT '关联实验项目ID',
    experiment_group VARCHAR(100) COMMENT '实验组别',
    environment_info JSON COMMENT '环境信息(温度、湿度等)',
    cage_size JSON COMMENT '鼠笼尺寸信息',
    status VARCHAR(20) DEFAULT 'REGISTERED' COMMENT '状态:REGISTERED,ACTIVE,INACTIVE,MAINTENANCE',
    activate_time DATETIME COMMENT '激活时间',
    last_activity DATETIME COMMENT '最后活动时间',
    description TEXT COMMENT '笼子描述',
    created_by BIGINT COMMENT '创建人ID',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted TINYINT DEFAULT 0 COMMENT '是否删除:0-否,1-是',
    INDEX idx_cage_id (cage_id),
    INDEX idx_device_id (device_id),
    INDEX idx_experiment_id (experiment_id),
    INDEX idx_status (status),
    INDEX idx_location (location)
);
```

#### 4.1.3 小鼠表 (t_mouse)
```sql
CREATE TABLE t_mouse (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    mouse_id VARCHAR(50) UNIQUE NOT NULL COMMENT '小鼠ID',
    cage_id VARCHAR(50) NOT NULL COMMENT '所属鼠笼ID',
    mouse_name VARCHAR(100) COMMENT '小鼠名称',
    mouse_code VARCHAR(50) COMMENT '小鼠编号',
    gender VARCHAR(10) COMMENT '性别:MALE,FEMALE,UNKNOWN',
    age_weeks INT COMMENT '周龄',
    weight_grams DECIMAL(6,2) COMMENT '体重(克)',
    strain VARCHAR(50) COMMENT '品系',
    source VARCHAR(100) COMMENT '来源',
    birth_date DATE COMMENT '出生日期',
    entry_date DATE COMMENT '入笼日期',
    health_status VARCHAR(20) DEFAULT 'HEALTHY' COMMENT '健康状态:HEALTHY,SICK,DEAD',
    tracking_color VARCHAR(20) COMMENT '追踪标识颜色',
    notes TEXT COMMENT '备注信息',
    created_by BIGINT COMMENT '创建人ID',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted TINYINT DEFAULT 0 COMMENT '是否删除:0-否,1-是',
    INDEX idx_mouse_id (mouse_id),
    INDEX idx_cage_id (cage_id),
    INDEX idx_health_status (health_status),
    INDEX idx_strain (strain)
);
```

#### 4.1.4 行为数据表 (t_behavior_data)
```sql
CREATE TABLE t_behavior_data (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    device_id VARCHAR(50) NOT NULL COMMENT '设备ID',
    cage_id VARCHAR(50) NOT NULL COMMENT '鼠笼ID',
    mouse_id VARCHAR(50) NOT NULL COMMENT '小鼠ID',
    behavior_type VARCHAR(50) NOT NULL COMMENT '行为类型:SLEEP,COUGH,NOSE_SCRATCH,DEFECATION,CONVULSION,MOVEMENT,EATING,DRINKING',
    behavior_subtype VARCHAR(50) COMMENT '行为子类型',
    confidence DECIMAL(5,4) NOT NULL COMMENT '置信度(0-1)',
    duration_seconds DECIMAL(10,3) COMMENT '持续时间(秒)',
    position_x DECIMAL(10,3) COMMENT 'X坐标',
    position_y DECIMAL(10,3) COMMENT 'Y坐标',
    bounding_box JSON COMMENT '边界框信息',
    start_time DATETIME NOT NULL COMMENT '开始时间',
    end_time DATETIME COMMENT '结束时间',
    frame_start INT COMMENT '开始帧号',
    frame_end INT COMMENT '结束帧号',
    video_file_path VARCHAR(500) COMMENT '视频文件路径',
    image_file_path VARCHAR(500) COMMENT '截图文件路径',
    additional_data JSON COMMENT '额外数据',
    is_verified TINYINT DEFAULT 0 COMMENT '是否已验证:0-否,1-是',
    verified_by BIGINT COMMENT '验证人ID',
    verified_time DATETIME COMMENT '验证时间',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_device_time (device_id, start_time),
    INDEX idx_cage_time (cage_id, start_time),
    INDEX idx_mouse_behavior (mouse_id, behavior_type),
    INDEX idx_time_range (start_time, end_time),
    INDEX idx_behavior_type (behavior_type),
    INDEX idx_confidence (confidence),
    INDEX idx_verified (is_verified)
);
```

#### 4.1.5 实验项目表 (t_experiment)
```sql
CREATE TABLE t_experiment (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    experiment_id VARCHAR(50) UNIQUE NOT NULL COMMENT '实验ID',
    experiment_name VARCHAR(200) NOT NULL COMMENT '实验名称',
    experiment_type VARCHAR(50) COMMENT '实验类型',
    description TEXT COMMENT '实验描述',
    principal_investigator VARCHAR(100) COMMENT '主要研究者',
    start_date DATE COMMENT '开始日期',
    end_date DATE COMMENT '结束日期',
    status VARCHAR(20) DEFAULT 'PLANNING' COMMENT '状态:PLANNING,RUNNING,PAUSED,COMPLETED,CANCELLED',
    protocol_file_path VARCHAR(500) COMMENT '实验方案文件路径',
    approval_number VARCHAR(100) COMMENT '伦理审批号',
    funding_source VARCHAR(200) COMMENT '资助来源',
    created_by BIGINT COMMENT '创建人ID',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted TINYINT DEFAULT 0 COMMENT '是否删除:0-否,1-是',
    INDEX idx_experiment_id (experiment_id),
    INDEX idx_status (status),
    INDEX idx_date_range (start_date, end_date)
);
```

#### 4.1.6 用户表 (t_user)
```sql
CREATE TABLE t_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    password VARCHAR(255) NOT NULL COMMENT '密码(加密)',
    real_name VARCHAR(100) COMMENT '真实姓名',
    email VARCHAR(100) COMMENT '邮箱',
    phone VARCHAR(20) COMMENT '电话',
    department VARCHAR(100) COMMENT '部门',
    role VARCHAR(50) DEFAULT 'USER' COMMENT '角色:ADMIN,RESEARCHER,OPERATOR,VIEWER',
    status VARCHAR(20) DEFAULT 'ACTIVE' COMMENT '状态:ACTIVE,INACTIVE,LOCKED',
    last_login_time DATETIME COMMENT '最后登录时间',
    last_login_ip VARCHAR(45) COMMENT '最后登录IP',
    created_by BIGINT COMMENT '创建人ID',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted TINYINT DEFAULT 0 COMMENT '是否删除:0-否,1-是',
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_status (status)
);
```

#### 4.1.7 标注任务表 (t_annotation_task)
```sql
CREATE TABLE t_annotation_task (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_id VARCHAR(50) UNIQUE NOT NULL COMMENT '任务ID',
    task_name VARCHAR(200) NOT NULL COMMENT '任务名称',
    task_type VARCHAR(50) COMMENT '任务类型:VIDEO_ANNOTATION,BEHAVIOR_ANNOTATION,QUALITY_CHECK',
    description TEXT COMMENT '任务描述',
    video_file_path VARCHAR(500) COMMENT '视频文件路径',
    start_frame INT COMMENT '开始帧',
    end_frame INT COMMENT '结束帧',
    assigned_to BIGINT COMMENT '分配给用户ID',
    priority VARCHAR(20) DEFAULT 'NORMAL' COMMENT '优先级:HIGH,NORMAL,LOW',
    status VARCHAR(20) DEFAULT 'PENDING' COMMENT '状态:PENDING,IN_PROGRESS,COMPLETED,REJECTED',
    deadline DATETIME COMMENT '截止时间',
    completed_time DATETIME COMMENT '完成时间',
    quality_score DECIMAL(3,2) COMMENT '质量评分(0-10)',
    notes TEXT COMMENT '备注',
    created_by BIGINT COMMENT '创建人ID',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_task_id (task_id),
    INDEX idx_assigned_to (assigned_to),
    INDEX idx_status (status),
    INDEX idx_deadline (deadline)
);
```

#### 4.1.8 标注结果表 (t_annotation_result)
```sql
CREATE TABLE t_annotation_result (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_id VARCHAR(50) NOT NULL COMMENT '任务ID',
    mouse_id VARCHAR(50) COMMENT '小鼠ID',
    behavior_type VARCHAR(50) NOT NULL COMMENT '行为类型',
    start_frame INT NOT NULL COMMENT '开始帧',
    end_frame INT NOT NULL COMMENT '结束帧',
    start_time DATETIME NOT NULL COMMENT '开始时间',
    end_time DATETIME NOT NULL COMMENT '结束时间',
    position_data JSON COMMENT '位置数据',
    annotation_data JSON COMMENT '标注数据',
    annotator_id BIGINT NOT NULL COMMENT '标注员ID',
    annotation_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '标注时间',
    is_verified TINYINT DEFAULT 0 COMMENT '是否已验证',
    verified_by BIGINT COMMENT '验证人ID',
    verified_time DATETIME COMMENT '验证时间',
    INDEX idx_task_id (task_id),
    INDEX idx_mouse_id (mouse_id),
    INDEX idx_behavior_type (behavior_type),
    INDEX idx_annotator (annotator_id),
    INDEX idx_time_range (start_time, end_time)
);
```

#### 4.1.9 系统日志表 (t_system_log)
```sql
CREATE TABLE t_system_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    log_type VARCHAR(50) NOT NULL COMMENT '日志类型:LOGIN,OPERATION,ERROR,SYSTEM',
    user_id BIGINT COMMENT '用户ID',
    module VARCHAR(100) COMMENT '模块名称',
    operation VARCHAR(200) COMMENT '操作描述',
    request_url VARCHAR(500) COMMENT '请求URL',
    request_method VARCHAR(10) COMMENT '请求方法',
    request_params TEXT COMMENT '请求参数',
    response_data TEXT COMMENT '响应数据',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    execution_time INT COMMENT '执行时间(毫秒)',
    status VARCHAR(20) COMMENT '状态:SUCCESS,FAILED,ERROR',
    error_message TEXT COMMENT '错误信息',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_log_type (log_type),
    INDEX idx_user_id (user_id),
    INDEX idx_created_time (created_time),
    INDEX idx_status (status)
);
```

#### 4.1.10 文件管理表 (t_file_info)
```sql
CREATE TABLE t_file_info (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    file_id VARCHAR(50) UNIQUE NOT NULL COMMENT '文件ID',
    file_name VARCHAR(255) NOT NULL COMMENT '文件名',
    file_type VARCHAR(50) COMMENT '文件类型:VIDEO,IMAGE,DOCUMENT,DATA',
    file_size BIGINT COMMENT '文件大小(字节)',
    file_path VARCHAR(500) NOT NULL COMMENT '文件路径',
    file_url VARCHAR(500) COMMENT '文件访问URL',
    mime_type VARCHAR(100) COMMENT 'MIME类型',
    md5_hash VARCHAR(32) COMMENT 'MD5哈希值',
    related_id VARCHAR(50) COMMENT '关联ID(设备、鼠笼、小鼠等)',
    related_type VARCHAR(50) COMMENT '关联类型',
    upload_by BIGINT COMMENT '上传人ID',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_deleted TINYINT DEFAULT 0 COMMENT '是否删除:0-否,1-是',
    INDEX idx_file_id (file_id),
    INDEX idx_file_type (file_type),
    INDEX idx_related (related_id, related_type),
    INDEX idx_upload_by (upload_by),
    INDEX idx_created_time (created_time)
);
```

#### 4.1.11 二维码管理表 (t_qr_code)
```sql
CREATE TABLE t_qr_code (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    qr_code_id VARCHAR(50) UNIQUE NOT NULL COMMENT '二维码ID',
    cage_id VARCHAR(50) NOT NULL COMMENT '关联笼子ID',
    qr_content TEXT NOT NULL COMMENT '二维码内容(JSON格式)',
    qr_image_url VARCHAR(500) COMMENT '二维码图片URL',
    qr_image_base64 LONGTEXT COMMENT '二维码图片Base64编码',
    generation_algorithm VARCHAR(50) DEFAULT 'QR_CODE' COMMENT '生成算法:QR_CODE,DATA_MATRIX',
    error_correction_level VARCHAR(10) DEFAULT 'M' COMMENT '纠错级别:L,M,Q,H',
    size_pixels INT DEFAULT 200 COMMENT '图片尺寸(像素)',
    is_active TINYINT DEFAULT 1 COMMENT '是否激活:0-否,1-是',
    scan_count INT DEFAULT 0 COMMENT '扫描次数',
    last_scan_time DATETIME COMMENT '最后扫描时间',
    last_scan_ip VARCHAR(45) COMMENT '最后扫描IP',
    expiry_time DATETIME COMMENT '过期时间',
    created_by BIGINT COMMENT '创建人ID',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted TINYINT DEFAULT 0 COMMENT '是否删除:0-否,1-是',
    INDEX idx_qr_code_id (qr_code_id),
    INDEX idx_cage_id (cage_id),
    INDEX idx_is_active (is_active),
    INDEX idx_scan_count (scan_count),
    INDEX idx_created_time (created_time),
    FOREIGN KEY (cage_id) REFERENCES t_cage(cage_id) ON DELETE CASCADE
);
```

#### 4.1.12 二维码扫描记录表 (t_qr_scan_log)
```sql
CREATE TABLE t_qr_scan_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    qr_code_id VARCHAR(50) NOT NULL COMMENT '二维码ID',
    cage_id VARCHAR(50) NOT NULL COMMENT '笼子ID',
    scan_result VARCHAR(20) NOT NULL COMMENT '扫描结果:SUCCESS,FAILED,EXPIRED,INVALID',
    scan_device VARCHAR(100) COMMENT '扫描设备信息',
    scan_ip VARCHAR(45) COMMENT '扫描IP地址',
    scan_location VARCHAR(200) COMMENT '扫描位置',
    user_agent TEXT COMMENT '用户代理信息',
    error_message TEXT COMMENT '错误信息(扫描失败时)',
    response_time INT COMMENT '响应时间(毫秒)',
    scan_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '扫描时间',
    INDEX idx_qr_code_id (qr_code_id),
    INDEX idx_cage_id (cage_id),
    INDEX idx_scan_result (scan_result),
    INDEX idx_scan_time (scan_time),
    INDEX idx_scan_ip (scan_ip)
);
```

## 5. 部署架构

### 5.1 Docker容器化部署

#### 5.1.1 生产环境Docker部署架构
```
┌─────────────────────────────────────────────────────────────────┐
│                    Docker Host (Linux/Windows)                  │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                Docker Compose 服务栈                        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │ │
│  │  │   Nginx     │  │Spring Boot  │  │   MySQL     │        │ │
│  │  │  (前端)     │  │  (后端)     │  │  (数据库)   │        │ │
│  │  │  Port:80    │  │  Port:8080  │  │  Port:3306  │        │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │ │
│  │  │   Redis     │  │   MinIO     │  │  标注工具    │        │ │
│  │  │  (缓存)     │  │  (文件)     │  │  (CVAT)     │        │ │
│  │  │  Port:6379  │  │  Port:9000  │  │  Port:8081  │        │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │ │
│  └─────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   数据卷挂载                                │ │
│  │  • /data/mysql     -> MySQL数据持久化                      │ │
│  │  • /data/redis     -> Redis数据持久化                      │ │
│  │  • /data/minio     -> MinIO文件存储                        │ │
│  │  • /data/videos    -> 视频文件存储                         │ │
│  │  • /data/logs      -> 应用日志存储                         │ │
│  │  • /data/config    -> 配置文件存储                         │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘

外部采集端 (独立部署)
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  采集端1    │  │  采集端2    │  │  采集端N    │
│             │  │             │  │             │
│  Python     │  │  Python     │  │  Python     │
│  Camera     │  │  Camera     │  │  Camera     │
│  GPU        │  │  GPU        │  │  GPU        │
└─────────────┘  └─────────────┘  └─────────────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
                   HTTP/WebSocket
                        │
                ┌───────▼───────┐
                │  Docker Host  │
                │   (服务端)    │
                └───────────────┘
```

#### 5.1.2 开发环境部署选择

**方案一：完全Docker化开发环境（推荐）**

**优势：**
- 环境一致性：开发、测试、生产环境完全一致
- 快速启动：一键启动所有服务
- 依赖隔离：避免本地环境污染
- 团队协作：新成员快速上手
- 版本控制：Docker镜像版本化管理

**劣势：**
- 调试复杂度稍高
- 资源占用相对较大

**方案二：混合开发环境**
- MySQL、Redis在Docker中运行
- Spring Boot在IDE中直接运行
- 前端在本地开发服务器运行

**推荐使用方案一的理由：**
1. **避免环境配置地狱**：MySQL版本、Redis版本、Java版本等不一致导致的问题
2. **快速环境重建**：系统崩溃或更换开发机器时，几分钟内恢复开发环境
3. **生产环境一致性**：减少"在我机器上能跑"的问题
4. **CI/CD友好**：持续集成环境与开发环境一致
5. **团队协作效率**：新成员只需要Docker即可开始开发

### 5.2 Docker Compose配置示例

```yaml
# docker-compose.yml
version: '3.8'

services:
  # MySQL数据库
  mysql:
    image: mysql:8.0
    container_name: mouse-mysql
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: mouse_monitor
      MYSQL_USER: mouse_user
      MYSQL_PASSWORD: mouse_pass
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - mouse-network

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: mouse-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - mouse-network

  # MinIO文件存储
  minio:
    image: minio/minio:latest
    container_name: mouse-minio
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: admin123
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - mouse-network

  # Spring Boot后端
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mouse-backend
    environment:
      SPRING_PROFILES_ACTIVE: docker
      MYSQL_HOST: mysql
      REDIS_HOST: redis
      MINIO_HOST: minio
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
      - minio
    volumes:
      - ./logs:/app/logs
      - ./data/videos:/app/videos
    networks:
      - mouse-network

  # Nginx前端
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: mouse-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - mouse-network

  # CVAT标注工具
  cvat:
    image: openvino/cvat_server:latest
    container_name: mouse-cvat
    environment:
      DJANGO_MODWSGI_EXTRA_ARGS: ""
      ALLOWED_HOSTS: "*"
    ports:
      - "8081:8080"
    volumes:
      - cvat_data:/home/django/data
      - cvat_keys:/home/django/keys
      - cvat_logs:/home/django/logs
    networks:
      - mouse-network

volumes:
  mysql_data:
  redis_data:
  minio_data:
  cvat_data:
  cvat_keys:
  cvat_logs:

networks:
  mouse-network:
    driver: bridge
```

### 5.3 部署脚本

#### 5.3.1 一键部署脚本 (deploy.ps1)
```powershell
# 计算机视觉小鼠管理系统一键部署脚本
# PowerShell版本 - 支持Windows环境

Write-Host "开始部署计算机视觉小鼠管理系统..." -ForegroundColor Green

# 检查Docker和Docker Compose
try {
    docker --version | Out-Null
    Write-Host "✓ Docker已安装" -ForegroundColor Green
} catch {
    Write-Host "✗ 错误: Docker未安装，请先安装Docker Desktop" -ForegroundColor Red
    exit 1
}

try {
    docker-compose --version | Out-Null
    Write-Host "✓ Docker Compose已安装" -ForegroundColor Green
} catch {
    Write-Host "✗ 错误: Docker Compose未安装，请先安装Docker Compose" -ForegroundColor Red
    exit 1
}

# 创建必要的目录
Write-Host "创建数据目录..." -ForegroundColor Yellow
$directories = @(
    "data\mysql",
    "data\redis", 
    "data\minio",
    "data\videos",
    "data\logs",
    "data\config",
    "sql"
)

foreach ($dir in $directories) {
    if (!(Test-Path $dir)) {
        New-Item -ItemType Directory -Path $dir -Force | Out-Null
        Write-Host "  创建目录: $dir" -ForegroundColor Gray
    }
}

# 停止并删除现有容器
Write-Host "停止现有服务..." -ForegroundColor Yellow
docker-compose down

# 构建并启动服务
Write-Host "构建并启动服务..." -ForegroundColor Yellow
docker-compose up -d --build

# 等待服务启动
Write-Host "等待服务启动..." -ForegroundColor Yellow
Start-Sleep -Seconds 30

# 检查服务状态
Write-Host "检查服务状态..." -ForegroundColor Yellow
docker-compose ps

# 显示访问地址
Write-Host ""
Write-Host "=== 部署完成！===" -ForegroundColor Green
Write-Host "前端访问地址: http://localhost" -ForegroundColor Cyan
Write-Host "后端API地址: http://localhost:8080" -ForegroundColor Cyan
Write-Host "MinIO控制台: http://localhost:9001" -ForegroundColor Cyan
Write-Host "CVAT标注工具: http://localhost:8081" -ForegroundColor Cyan
Write-Host ""
Write-Host "默认账号密码请查看docker-compose.yml文件" -ForegroundColor Yellow
Write-Host "系统初始化可能需要几分钟时间，请耐心等待" -ForegroundColor Yellow
```

#### 5.3.2 Linux部署脚本 (deploy.sh)
```bash
#!/bin/bash

# 计算机视觉小鼠管理系统一键部署脚本
# Linux版本

echo "开始部署计算机视觉小鼠管理系统..."

# 检查Docker和Docker Compose
if ! command -v docker &> /dev/null; then
    echo "错误: Docker未安装，请先安装Docker"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo "错误: Docker Compose未安装，请先安装Docker Compose"
    exit 1
fi

# 创建必要的目录
echo "创建数据目录..."
mkdir -p data/{mysql,redis,minio,videos,logs,config}
mkdir -p sql

# 停止并删除现有容器
echo "停止现有服务..."
docker-compose down

# 构建并启动服务
echo "构建并启动服务..."
docker-compose up -d --build

# 等待服务启动
echo "等待服务启动..."
sleep 30

# 检查服务状态
echo "检查服务状态..."
docker-compose ps

# 显示访问地址
echo ""
echo "=== 部署完成！==="
echo "前端访问地址: http://localhost"
echo "后端API地址: http://localhost:8080"
echo "MinIO控制台: http://localhost:9001"
echo "CVAT标注工具: http://localhost:8081"
echo ""
echo "默认账号密码请查看docker-compose.yml文件"
echo "系统初始化可能需要几分钟时间，请耐心等待"
```

## 6. 性能指标

### 6.1 系统性能要求

#### 6.1.1 计算机视觉性能
- **视频处理**: 30fps实时处理，支持1080p分辨率
- **目标检测**: <50ms延迟，检测精度>95%
- **行为识别**: <100ms延迟，识别精度>90%
- **多目标追踪**: 同时追踪20只小鼠，追踪准确率>95%
- **二维码识别**: <30ms识别延迟，识别成功率>99%

#### 6.1.2 系统并发性能
- **设备接入**: 支持50个采集端同时接入
- **用户并发**: 支持100个用户同时在线
- **API响应**: 平均响应时间<200ms
- **WebSocket连接**: 支持1000个并发连接
- **数据处理**: 每秒处理10000条行为数据

#### 6.1.3 存储性能
- **数据存储**: 支持PB级数据存储
- **视频存储**: 支持10TB/天的视频数据
- **数据备份**: 支持增量备份和全量备份
- **数据查询**: 复杂查询响应时间<3秒

### 6.2 硬件配置建议

#### 6.2.1 采集端配置
**基础配置:**
- **CPU**: Intel i5-10400或AMD Ryzen 5 3600以上
- **GPU**: NVIDIA GTX 1660 Super或以上(支持CUDA 11.0+)
- **内存**: 16GB DDR4
- **存储**: 256GB SSD + 1TB HDD
- **摄像头**: 1080p@30fps，支持USB 3.0

**推荐配置:**
- **CPU**: Intel i7-11700或AMD Ryzen 7 5700X
- **GPU**: NVIDIA RTX 3060或以上
- **内存**: 32GB DDR4
- **存储**: 512GB NVMe SSD + 2TB HDD
- **摄像头**: 4K@30fps，支持USB 3.1

#### 6.2.2 服务端配置
**最小配置:**
- **CPU**: Intel Xeon E-2236或AMD EPYC 7232P
- **内存**: 32GB ECC DDR4
- **存储**: 1TB NVMe SSD + 4TB HDD
- **网络**: 千兆以太网

**推荐配置:**
- **CPU**: Intel Xeon Silver 4214或AMD EPYC 7402P
- **内存**: 64GB ECC DDR4
- **存储**: 2TB NVMe SSD + 20TB HDD RAID5
- **网络**: 万兆以太网

**高性能配置:**
- **CPU**: Intel Xeon Gold 6248或AMD EPYC 7542
- **内存**: 128GB ECC DDR4
- **存储**: 4TB NVMe SSD + 100TB HDD RAID6
- **网络**: 万兆以太网 + 光纤连接

## 7. 安全设计

### 7.1 身份认证与授权

#### 7.1.1 多层认证机制
- **JWT Token认证**: 支持访问令牌和刷新令牌
- **双因子认证**: 支持短信验证码和邮箱验证
- **设备指纹识别**: 防止异常设备访问
- **会话管理**: 支持单点登录和强制下线

#### 7.1.2 权限控制系统
- **RBAC权限模型**: 基于角色的访问控制
- **细粒度权限**: 支持功能级和数据级权限控制
- **权限继承**: 支持角色权限继承和组合
- **动态权限**: 支持运行时权限调整

#### 7.1.3 API安全防护
- **访问限流**: 基于IP和用户的请求频率限制
- **API签名验证**: 防止API调用篡改
- **白名单机制**: 限制可访问的IP地址范围
- **请求加密**: 敏感API请求内容加密传输

### 7.2 数据安全保护

#### 7.2.1 数据加密存储
- **数据库加密**: 敏感字段AES-256加密存储
- **文件加密**: 视频文件和图片文件加密存储
- **密钥管理**: 采用密钥轮换和分级管理
- **传输加密**: 全站HTTPS/WSS加密传输

#### 7.2.2 二维码安全管理
- **二维码内容加密**: 二维码内容采用AES加密
- **时效性控制**: 二维码支持过期时间设置
- **扫描次数限制**: 防止二维码被恶意扫描
- **扫描日志记录**: 详细记录每次扫描行为

#### 7.2.3 数据备份与恢复
- **自动备份**: 支持定时全量和增量备份
- **异地备份**: 支持多地备份存储
- **备份加密**: 备份文件采用强加密算法
- **快速恢复**: 支持分钟级数据恢复

### 7.3 网络安全防护

#### 7.3.1 网络边界防护
- **防火墙配置**: 严格的入站和出站规则
- **DDoS防护**: 分布式拒绝服务攻击防护
- **入侵检测**: 实时网络入侵检测系统
- **流量监控**: 异常流量实时告警

#### 7.3.2 应用安全防护
- **SQL注入防护**: 参数化查询和输入验证
- **XSS攻击防护**: 输出编码和CSP策略
- **CSRF防护**: Token验证和同源检查
- **文件上传安全**: 文件类型和大小限制

#### 7.3.3 运维安全管理
- **VPN访问控制**: 管理员远程访问VPN
- **操作审计**: 详细的操作日志记录
- **安全扫描**: 定期安全漏洞扫描
- **应急响应**: 安全事件应急处理流程

### 7.4 合规性要求

#### 7.4.1 数据保护合规
- **个人信息保护**: 符合个人信息保护法要求
- **数据最小化**: 仅收集必要的数据信息
- **数据删除**: 支持数据删除和匿名化
- **隐私政策**: 明确的隐私保护政策

#### 7.4.2 实验动物管理合规
- **实验记录**: 完整的实验过程记录
- **动物福利**: 符合实验动物福利要求
- **数据溯源**: 支持实验数据完整溯源
- **监管报告**: 支持监管部门数据报告