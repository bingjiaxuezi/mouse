# 实验驱动小鼠管理系统 - 技术选型建议

## 1. 实验驱动架构技术选型概述

### 核心设计理念
- **实验优先**: 所有技术选型围绕实验管理核心展开
- **数据溯源**: 确保所有采集数据可追溯到具体实验
- **配置驱动**: 支持基于实验模板的动态配置
- **质量保证**: 实验数据质量监控和验证机制

## 2. Python数据采集端技术选型

### 推荐方案：OpenCV + YOLOv8 + DeepSORT + MediaPipe + ZXing + 实验配置管理

#### 核心组件详细实现：

**1. OpenCV (计算机视觉基础库)**
- **License**: BSD-3-Clause（宽松开源许可）
- **版本**: 4.8+
- **安装**: `pip install opencv-python opencv-contrib-python`
- **优点**: 成熟稳定、功能全面、社区活跃、支持多种摄像头
- **适配**: 提供视频流处理、图像预处理、基础图像操作

```python
# 视频流处理实现
import cv2

class VideoCapture:
    def __init__(self, source=0):
        self.cap = cv2.VideoCapture(source)
        self.cap.set(cv2.CAP_PROP_FRAME_WIDTH, 1920)
        self.cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 1080)
        self.cap.set(cv2.CAP_PROP_FPS, 30)
    
    def read_frame(self):
        ret, frame = self.cap.read()
        if ret:
            # 图像预处理
            frame = cv2.GaussianBlur(frame, (5, 5), 0)
            frame = cv2.convertScaleAbs(frame, alpha=1.2, beta=10)
        return ret, frame
```

**2. YOLOv8 (目标检测)**
- **推荐版本**: YOLOv8 (Ultralytics)
- **License**: AGPL-3.0（需注意商业使用）
- **安装**: `pip install ultralytics`
- **优点**: 实时性好、精度高、支持自定义训练
- **适配**: 用于小鼠检测，可通过标注数据训练适应垫料环境
- **缺点**: 商业使用需考虑License限制

```python
from ultralytics import YOLO
import torch

class MouseDetector:
    def __init__(self, model_path='yolov8n.pt'):
        self.model = YOLO(model_path)
        self.device = 'cuda' if torch.cuda.is_available() else 'cpu'
        self.model.to(self.device)
    
    def detect_mice(self, frame):
        results = self.model(frame, conf=0.5, iou=0.4)
        detections = []
        for result in results:
            boxes = result.boxes
            if boxes is not None:
                for box in boxes:
                    x1, y1, x2, y2 = box.xyxy[0].cpu().numpy()
                    conf = box.conf[0].cpu().numpy()
                    detections.append({
                        'bbox': [x1, y1, x2, y2],
                        'confidence': conf
                    })
        return detections
```

**3. DeepSORT (多目标追踪)**
- **License**: GPL-3.0
- **安装**: `pip install deep-sort-realtime`
- **优点**: 多目标追踪效果好、身份保持能力强
- **适配**: 解决5只小鼠同时追踪问题
- **缺点**: 在遮挡严重时可能出现ID切换

```python
from deep_sort_realtime import DeepSort

class MouseTracker:
    def __init__(self):
        self.tracker = DeepSort(
            max_age=50,
            n_init=3,
            nms_max_overlap=1.0,
            max_cosine_distance=0.2,
            embedder="mobilenet",
            half=True,
            bgr=True,
            embedder_gpu=True
        )
    
    def update_tracks(self, detections, frame):
        dets = []
        for det in detections:
            x1, y1, x2, y2 = det['bbox']
            conf = det['confidence']
            dets.append(([x1, y1, x2-x1, y2-y1], conf, 'mouse'))
        
        tracks = self.tracker.update_tracks(dets, frame=frame)
        return tracks
```

**4. MediaPipe (行为识别辅助)**
- **License**: Apache-2.0（宽松开源许可）
- **安装**: `pip install mediapipe`
- **优点**: Google开源、轻量级、支持姿态估计
- **适配**: 辅助识别挠鼻、抽搐等细微动作

**5. ZXing (二维码识别)**
- **License**: Apache-2.0（宽松开源许可）
- **安装**: `pip install pyzxing`
- **优点**: 支持多种二维码格式、识别精度高、跨平台
- **适配**: 用于笼子二维码识别和设备绑定

```python
import mediapipe as mp
import numpy as np

class BehaviorAnalyzer:
    def __init__(self):
        self.mp_pose = mp.solutions.pose
        self.pose = self.mp_pose.Pose(
            static_image_mode=False,
            model_complexity=1,
            min_detection_confidence=0.5
        )
    
    def analyze_behavior(self, mouse_roi, track_history):
        behaviors = {
            'sleeping': False,
            'grooming': False,
            'scratching': False,
            'twitching': False
        }
        
        # 运动分析
        motion_intensity = self._calculate_motion(track_history)
        if motion_intensity < 0.1:
            behaviors['sleeping'] = True
            
        return behaviors
```

```python
from pyzxing import BarCodeReader
import cv2
import numpy as np

class QRCodeScanner:
    def __init__(self):
        self.reader = BarCodeReader()
        self.qr_detector = cv2.QRCodeDetector()
    
    def scan_qr_code(self, frame):
        """扫描帧中的二维码"""
        # 方法1: 使用OpenCV内置QR检测器
        data, bbox, _ = self.qr_detector.detectAndDecode(frame)
        if data:
            return {
                'data': data,
                'bbox': bbox,
                'method': 'opencv'
            }
        
        # 方法2: 使用ZXing库作为备选
        try:
            results = self.reader.decode_array(frame)
            if results:
                return {
                    'data': results[0]['parsed'],
                    'format': results[0]['format'],
                    'method': 'zxing'
                }
        except Exception as e:
            print(f"ZXing解码失败: {e}")
        
        return None
    
    def generate_qr_code(self, data, size=(200, 200)):
        """生成二维码图片"""
        import qrcode
        qr = qrcode.QRCode(
            version=1,
            error_correction=qrcode.constants.ERROR_CORRECT_L,
            box_size=10,
            border=4,
        )
        qr.add_data(data)
        qr.make(fit=True)
        
        img = qr.make_image(fill_color="black", back_color="white")
        return np.array(img.resize(size))
```

#### 替代方案考虑：

**MMDetection + MMTracking (OpenMMLab)**
- **License**: Apache-2.0（更宽松）
- **优点**: 学术界认可度高、模型丰富、易于扩展
- **缺点**: 学习曲线较陡峭

### 人工标注支持：

**推荐工具**: CVAT (Computer Vision Annotation Tool)
- **License**: MIT（宽松开源许可）
- **功能**: 支持视频标注、多类别标注、团队协作
- **集成**: 可导出YOLO格式数据用于模型训练

## 2. Spring Boot后端技术选型

### 推荐脚手架：RuoYi-Vue-Plus + 二维码管理扩展

#### 选择理由：
- **完整的RBAC权限管理**: 支持用户、角色、菜单、部门管理
- **"三员"管理**: 系统管理员、安全管理员、审计管理员分离
- **丰富的基础功能**: 
  - 数据权限控制
  - 操作日志记录
  - 系统监控
  - 代码生成器
  - 定时任务
- **技术栈现代化**: Spring Boot 3.x + Spring Security + MyBatis-Plus
- **License**: MIT（宽松开源许可）
- **二维码管理扩展**: 集成ZXing-Java、图片处理、设备绑定管理

#### 核心特性：
- **安全性**: 集成Spring Security，支持JWT认证
- **数据库**: 支持MySQL、PostgreSQL等主流数据库
- **缓存**: 集成Redis缓存
- **文档**: 集成Swagger/Knife4j API文档
- **监控**: 集成Spring Boot Admin
- **二维码服务**: 集成ZXing-Java库，支持二维码生成、识别、管理
- **图片处理**: 集成ImageIO、BufferedImage进行二维码图片处理
- **设备管理**: 支持设备与笼子的绑定关系管理

### 替代方案：

**Pig (基于Spring Cloud Alibaba)**
- **优点**: 微服务架构、功能更丰富
- **缺点**: 复杂度较高，适合大型项目

## 3. 其他组件选型

### 数据库：MySQL 8.0+
- **理由**: 成熟稳定、性能优秀、社区支持好
- **特性**: 支持JSON字段存储复杂数据结构
- **二维码存储**: 支持BLOB字段存储二维码图片，TEXT字段存储二维码数据

### 前端框架：Vue 3 + Element Plus
- **Web端**: Vue 3 + Vite + Element Plus + ECharts + QRCode.js
- **移动端**: uni-app + uView UI + uni-qrcode
- **理由**: 生态成熟、开发效率高、跨平台支持好
- **二维码支持**: QRCode.js用于Web端二维码生成，uni-qrcode用于移动端

### 二维码处理库：
- **后端**: ZXing-Java (Apache-2.0)
- **前端Web**: QRCode.js (MIT)
- **前端移动**: uni-qrcode (MIT)
- **Python端**: python-qrcode + pyzxing (MIT + Apache-2.0)

#### Vue转uni-app实现步骤：

**1. 项目初始化**
```bash
# 创建uni-app项目
npx @dcloudio/uvm@latest create mouse-monitor-mobile
cd mouse-monitor-mobile
npm install
```

**2. 组件适配**
```javascript
// Vue 3组件转换示例
// 原Vue组件
<template>
  <div class="container">
    <el-table :data="mouseData">
      <el-table-column prop="id" label="小鼠ID"/>
    </el-table>
  </div>
</template>

// uni-app组件
<template>
  <view class="container">
    <u-table>
      <u-tr v-for="mouse in mouseData" :key="mouse.id">
        <u-td>{{ mouse.id }}</u-td>
      </u-tr>
    </u-table>
  </view>
</template>
```

**3. API调用适配**
```javascript
// 统一请求封装
class ApiService {
  static baseURL = process.env.NODE_ENV === 'development' 
    ? 'http://localhost:8080' 
    : 'https://api.mouseMonitor.com'
  
  static request(options) {
    return new Promise((resolve, reject) => {
      uni.request({
        url: this.baseURL + options.url,
        method: options.method || 'GET',
        data: options.data,
        header: {
          'Authorization': uni.getStorageSync('token'),
          'Content-Type': 'application/json'
        },
        success: resolve,
        fail: reject
      })
    })
  }
}
```

**4. 状态管理**
```javascript
// Pinia状态管理
import { defineStore } from 'pinia'

export const useMouseStore = defineStore('mouse', {
  state: () => ({
    mouseList: [],
    currentMouse: null,
    behaviorData: []
  }),
  
  actions: {
    async fetchMouseData() {
      const res = await ApiService.request({
        url: '/api/mouse/list'
      })
      this.mouseList = res.data
    }
  }
})
```

### API文档：APIFOX
- **理由**: 集成API设计、调试、文档、Mock于一体
- **优势**: 支持团队协作、自动化测试、数据模拟
- **集成**: 可导入Swagger文档，支持多环境管理

### 消息队列：Redis + Spring Boot Starter
- **用途**: 处理视频分析任务队列、实时数据推送、二维码扫描事件通知
- **二维码应用**: 设备绑定事件、二维码状态变更通知、批量二维码生成任务

### 文件存储：MinIO
- **用途**: 存储视频文件、图片、分析结果、二维码图片
- **理由**: 兼容S3 API、部署简单、性能好
- **二维码存储**: 支持二维码图片的分布式存储和CDN加速访问

## 4. 技术架构优势

### 许可证兼容性：
- 大部分组件使用MIT/Apache-2.0等宽松许可
- 需注意YOLO的AGPL-3.0许可（商业使用需考虑）

### 扩展性：
- 模块化设计，便于添加新的行为识别算法
- 支持分布式部署，可扩展到多个鼠笼

### 可维护性：
- 成熟的开源项目，社区支持好
- 详细的文档和示例代码

### 性能考虑：
- 支持GPU加速（CUDA）
- 异步处理机制
- 缓存优化

## 5. 风险评估

### 技术风险：
- **行为识别精度**: 需要大量标注数据和模型调优
- **多目标追踪稳定性**: 在遮挡情况下可能出现ID切换
- **实时性要求**: 需要合理的硬件配置

### 解决方案：
- 采用渐进式开发，先实现基础功能
- 建立完善的测试数据集
- 提供人工校正机制

## 6. 开发建议

### 第一阶段：基础框架
- 搭建基础的检测和追踪系统
- 实现简单的运动状态识别
- 建立数据采集和存储流程
- 完成Web端基础功能开发
- **二维码基础功能**: 实现二维码生成、识别、存储的基础API

### 第二阶段：行为识别与设备管理
- 重点攻克咳嗽、挠鼻等关键行为
- 建立标注工具和训练流程
- 优化识别精度
- 使用APIFOX完善API文档和测试
- **二维码设备绑定**: 实现设备与笼子的二维码绑定管理
- **二维码扫描集成**: 将二维码扫描集成到视频分析流程中

### 第三阶段：移动端开发
- 基于uni-app开发移动端应用
- 实现Vue组件到uni-app的迁移
- 适配不同平台的UI组件
- 完成跨平台兼容性测试
- **移动端二维码**: 实现移动端二维码扫描、生成、管理功能

### 第四阶段：系统完善
- 添加更多行为类型
- 完善统计分析功能
- 优化用户体验
- 性能调优和部署优化
- **二维码高级功能**: 批量二维码管理、二维码状态监控、设备绑定历史追踪