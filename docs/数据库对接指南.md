# 小鼠行为数据库对接指南

## 概述

本指南说明如何将新的行为数据表结构与现有的 `t_mouse` 表进行对接，确保数据一致性和系统兼容性。

## 现有表结构分析

### t_mouse 表结构
```sql
CREATE TABLE `t_mouse` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '小鼠ID',
  `mouse_code` varchar(50) NOT NULL COMMENT '小鼠编码',
  `mouse_name` varchar(100) DEFAULT NULL COMMENT '小鼠名称',
  `species` varchar(50) DEFAULT NULL COMMENT '品种',
  `gender` char(1) DEFAULT NULL COMMENT '性别',
  `birth_date` date DEFAULT NULL COMMENT '出生日期',
  `weight` decimal(6,2) DEFAULT NULL COMMENT '体重(g)',
  `cage_code` varchar(50) DEFAULT NULL COMMENT '笼子编码',
  `status` char(1) DEFAULT '1' COMMENT '状态',
  `create_by` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `update_by` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_mouse_code` (`mouse_code`),
  KEY `idx_cage_code` (`cage_code`),
  CONSTRAINT `fk_mouse_cage` FOREIGN KEY (`cage_code`) REFERENCES `t_cage` (`cage_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='小鼠信息表';
```

## 新表结构说明

### 1. t_behavior_type (行为类型字典表)
- **用途**: 定义19种核心行为类型
- **关键字段**: `type_code`, `type_name`, `category`
- **与t_mouse关系**: 无直接关系，作为字典表使用

### 2. t_behavior_data (优化后的行为数据表)
- **用途**: 记录小鼠行为数据
- **关键字段**: `mouse_code` (外键关联t_mouse)
- **与t_mouse关系**: 通过 `mouse_code` 字段关联

### 3. t_position_track (位置轨迹表)
- **用途**: 记录小鼠位置轨迹
- **关键字段**: `mouse_code` (外键关联t_mouse)
- **与t_mouse关系**: 通过 `mouse_code` 字段关联

### 4. t_physiological_state (生理状态表)
- **用途**: 记录小鼠生理状态(体重、体温等)
- **关键字段**: `mouse_code` (外键关联t_mouse)
- **与t_mouse关系**: 通过 `mouse_code` 字段关联

## 数据对接方案

### 1. 主键关联策略

所有新表都通过 `mouse_code` 字段与 `t_mouse` 表建立外键关系：

```sql
-- 行为数据表外键
ALTER TABLE t_behavior_data 
ADD CONSTRAINT fk_behavior_mouse 
FOREIGN KEY (mouse_code) REFERENCES t_mouse(mouse_code);

-- 位置轨迹表外键
ALTER TABLE t_position_track 
ADD CONSTRAINT fk_position_mouse 
FOREIGN KEY (mouse_code) REFERENCES t_mouse(mouse_code);

-- 生理状态表外键
ALTER TABLE t_physiological_state 
ADD CONSTRAINT fk_physio_mouse 
FOREIGN KEY (mouse_code) REFERENCES t_mouse(mouse_code);
```

### 2. 数据查询示例

#### 查询特定小鼠的所有行为数据
```sql
SELECT 
    m.mouse_name,
    m.species,
    bt.type_name,
    bd.behavior_value,
    bd.confidence,
    bd.timestamp
FROM t_mouse m
JOIN t_behavior_data bd ON m.mouse_code = bd.mouse_code
JOIN t_behavior_type bt ON bd.behavior_type_id = bt.id
WHERE m.mouse_code = 'M001'
ORDER BY bd.timestamp DESC;
```

#### 查询小鼠的位置轨迹
```sql
SELECT 
    m.mouse_name,
    pt.x_coordinate,
    pt.y_coordinate,
    pt.velocity,
    pt.timestamp
FROM t_mouse m
JOIN t_position_track pt ON m.mouse_code = pt.mouse_code
WHERE m.mouse_code = 'M001'
AND pt.timestamp >= '2024-01-01 00:00:00'
ORDER BY pt.timestamp;
```

#### 查询小鼠的生理状态变化
```sql
SELECT 
    m.mouse_name,
    ps.state_type,
    ps.state_value,
    ps.unit,
    ps.timestamp
FROM t_mouse m
JOIN t_physiological_state ps ON m.mouse_code = ps.mouse_code
WHERE m.mouse_code = 'M001'
AND ps.state_type IN ('weight', 'temperature')
ORDER BY ps.state_type, ps.timestamp;
```

### 3. 数据插入示例

#### 插入行为数据
```sql
INSERT INTO t_behavior_data (
    device_code, mouse_code, experiment_id, behavior_type_id, 
    behavior_value, confidence, timestamp, create_by, create_time
) VALUES (
    'DEV001', 'M001', 1, 
    (SELECT id FROM t_behavior_type WHERE type_code = 'walk'),
    'normal_walking', 0.95, NOW(), 'system', NOW()
);
```

#### 插入位置轨迹
```sql
INSERT INTO t_position_track (
    device_code, mouse_code, experiment_id, 
    x_coordinate, y_coordinate, velocity, timestamp, create_by, create_time
) VALUES (
    'DEV001', 'M001', 1, 10.5, 20.3, 5.2, NOW(), 'system', NOW()
);
```

#### 插入生理状态
```sql
INSERT INTO t_physiological_state (
    device_code, mouse_code, experiment_id, state_type, 
    state_value, unit, confidence, timestamp, create_by, create_time
) VALUES (
    'DEV001', 'M001', 1, 'weight', 25.6, 'g', 0.98, NOW(), 'system', NOW()
);
```

## 后端代码对接建议

### 1. 实体类映射

```java
// 行为数据实体类
@Entity
@Table(name = "t_behavior_data")
public class BehaviorData {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "mouse_code")
    private String mouseCode;
    
    // 关联小鼠实体
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "mouse_code", referencedColumnName = "mouse_code", insertable = false, updatable = false)
    private Mouse mouse;
    
    // 关联行为类型
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "behavior_type_id")
    private BehaviorType behaviorType;
    
    // 其他字段...
}
```

### 2. 服务层对接

```java
@Service
public class BehaviorDataService {
    
    @Autowired
    private BehaviorDataMapper behaviorDataMapper;
    
    @Autowired
    private MouseService mouseService;
    
    /**
     * 根据小鼠编码查询行为数据
     */
    public List<BehaviorData> getBehaviorDataByMouseCode(String mouseCode) {
        // 验证小鼠是否存在
        Mouse mouse = mouseService.getByMouseCode(mouseCode);
        if (mouse == null) {
            throw new BusinessException("小鼠不存在: " + mouseCode);
        }
        
        return behaviorDataMapper.selectByMouseCode(mouseCode);
    }
    
    /**
     * 插入行为数据
     */
    public int insertBehaviorData(BehaviorData behaviorData) {
        // 验证小鼠编码
        validateMouseCode(behaviorData.getMouseCode());
        
        return behaviorDataMapper.insert(behaviorData);
    }
    
    private void validateMouseCode(String mouseCode) {
        Mouse mouse = mouseService.getByMouseCode(mouseCode);
        if (mouse == null) {
            throw new BusinessException("无效的小鼠编码: " + mouseCode);
        }
    }
}
```

## 数据迁移建议

### 1. 现有数据迁移

如果现有 `t_behavior_data` 表中有数据，需要进行数据迁移：

```sql
-- 备份现有数据
CREATE TABLE t_behavior_data_backup AS SELECT * FROM t_behavior_data;

-- 迁移数据到新结构
INSERT INTO t_behavior_data_new (
    device_code, mouse_code, experiment_id, behavior_type_id,
    behavior_value, confidence, timestamp, create_by, create_time
)
SELECT 
    bd.device_code,
    bd.mouse_code,
    bd.experiment_id,
    bt.id as behavior_type_id,
    bd.behavior_value,
    bd.confidence,
    bd.timestamp,
    bd.create_by,
    bd.create_time
FROM t_behavior_data_backup bd
LEFT JOIN t_behavior_type bt ON bd.behavior_type = bt.type_code;
```

### 2. 数据一致性检查

```sql
-- 检查外键约束
SELECT COUNT(*) as invalid_mouse_codes
FROM t_behavior_data bd
LEFT JOIN t_mouse m ON bd.mouse_code = m.mouse_code
WHERE m.mouse_code IS NULL;

-- 检查行为类型完整性
SELECT COUNT(*) as invalid_behavior_types
FROM t_behavior_data bd
LEFT JOIN t_behavior_type bt ON bd.behavior_type_id = bt.id
WHERE bt.id IS NULL;
```

## 性能优化建议

### 1. 索引优化

```sql
-- 为常用查询添加复合索引
CREATE INDEX idx_mouse_time ON t_behavior_data(mouse_code, timestamp);
CREATE INDEX idx_mouse_behavior_time ON t_behavior_data(mouse_code, behavior_type_id, timestamp);
CREATE INDEX idx_experiment_time ON t_behavior_data(experiment_id, timestamp);
```

### 2. 分区建议

对于大量历史数据，建议按时间分区：

```sql
-- 按月分区示例
ALTER TABLE t_behavior_data 
PARTITION BY RANGE (YEAR(timestamp) * 100 + MONTH(timestamp)) (
    PARTITION p202401 VALUES LESS THAN (202402),
    PARTITION p202402 VALUES LESS THAN (202403),
    -- 继续添加分区...
);
```

## 注意事项

1. **数据完整性**: 确保所有外键约束正确设置
2. **性能考虑**: 大量数据插入时考虑批量操作
3. **事务管理**: 跨表操作时使用事务确保数据一致性
4. **监控告警**: 设置数据库监控，及时发现异常
5. **备份策略**: 定期备份重要数据

## 总结

新的数据库结构通过以下方式与现有 `t_mouse` 表完美对接：

- ✅ 保持 `t_mouse` 表结构不变
- ✅ 通过 `mouse_code` 字段建立关联
- ✅ 支持19种行为类型的标准化管理
- ✅ 提供位置轨迹和生理状态的独立存储
- ✅ 符合第三范式，避免数据冗余
- ✅ 支持高效查询和数据分析

这种设计既保证了与现有系统的兼容性，又为未来的功能扩展提供了良好的基础。