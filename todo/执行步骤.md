# 小鼠行为监测系统 - 详细执行步骤

## ✅ 已完成步骤（后端环境搭建）

### ✅ 步骤1: Docker环境验证 - 已完成
- Docker Desktop运行正常
- Docker网络 `docker_mouse-network` 已创建
- 基础命令测试通过

### ✅ 步骤2: MySQL数据库服务 - 已完成
- MySQL 8.0容器启动成功
- 数据库 `mouse_behavior` 已创建
- RuoYi框架数据表已导入（25个表）
- 数据库连接测试通过

### ✅ 步骤3: RuoYi后端服务 - 已完成
- 项目编译成功
- 后端服务启动成功
- 服务访问地址：http://localhost:8092
- 数据库连接配置正确

### ✅ 步骤4: 自动化脚本工具 - 已完成
- 快速启动脚本：`scripts/quick-start.ps1`
- 环境检查脚本：`scripts/check-environment.ps1`
- 数据库初始化脚本：`scripts/init-database.ps1`
- 脚本使用文档：`scripts/README.md`

## 🚀 快速使用方法（推荐）

### 一键启动整个后端环境
```powershell
# 在项目根目录执行
.\scripts\quick-start.ps1
```

### 环境检查和诊断
```powershell
# 检查Docker环境、网络、容器状态
.\scripts\check-environment.ps1
```

### 手动操作（高级用户）
```powershell
# 仅启动MySQL
cd docker
docker-compose up -d mysql

# 编译项目
docker run --rm -v "${PWD}:/app" -w /app maven:3.8.4-openjdk-17 mvn clean package -DskipTests

# 启动后端服务
docker run --rm -v "${PWD}:/app" -w /app -p 8092:80 --network docker_mouse-network maven:3.8.4-openjdk-17 java -jar ruoyi-admin/target/ruoyi-admin.jar
```

### 步骤4: 创建数据库表结构
```sql
-- 连接到MySQL后执行以下SQL
USE mouse_behavior;

-- 用户表
CREATE TABLE t_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    phone VARCHAR(20),
    real_name VARCHAR(50),
    role_id BIGINT,
    status TINYINT DEFAULT 1,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_status (status)
);

-- 设备表
CREATE TABLE t_device (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    device_id VARCHAR(50) NOT NULL UNIQUE,
    device_name VARCHAR(100) NOT NULL,
    device_type VARCHAR(20) DEFAULT 'camera',
    location VARCHAR(100),
    ip_address VARCHAR(15),
    mac_address VARCHAR(17),
    api_key VARCHAR(100),
    status TINYINT DEFAULT 1,
    last_heartbeat DATETIME,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_device_id (device_id),
    INDEX idx_status (status)
);

-- 实验项目表
CREATE TABLE t_experiment (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    experiment_name VARCHAR(100) NOT NULL,
    experiment_code VARCHAR(50) NOT NULL UNIQUE,
    description TEXT,
    researcher_id BIGINT,
    start_time DATETIME,
    end_time DATETIME,
    status TINYINT DEFAULT 1,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_experiment_code (experiment_code),
    INDEX idx_researcher_id (researcher_id)
);

-- 小鼠表
CREATE TABLE t_mouse (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    mouse_id VARCHAR(50) NOT NULL UNIQUE,
    mouse_name VARCHAR(50),
    species VARCHAR(50),
    strain VARCHAR(50),
    gender ENUM('male', 'female'),
    birth_date DATE,
    weight DECIMAL(5,2),
    cage_id BIGINT,
    experiment_id BIGINT,
    status TINYINT DEFAULT 1,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_mouse_id (mouse_id),
    INDEX idx_cage_id (cage_id),
    INDEX idx_experiment_id (experiment_id)
);

-- 行为数据表
CREATE TABLE t_behavior_data (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    device_id VARCHAR(50) NOT NULL,
    mouse_id VARCHAR(50),
    experiment_id BIGINT,
    behavior_type VARCHAR(50),
    behavior_value JSON,
    confidence DECIMAL(3,2),
    timestamp DATETIME NOT NULL,
    video_file VARCHAR(200),
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_device_timestamp (device_id, timestamp),
    INDEX idx_mouse_timestamp (mouse_id, timestamp),
    INDEX idx_experiment_timestamp (experiment_id, timestamp)
);

-- 插入测试数据
INSERT INTO t_user (username, password, email, real_name, role_id) VALUES
('admin', '$2a$10$7JB720yubVSOfvVMe6/YqO4wkhWGEn67XVb1Q0K1EFyLWY1uIHe1a', 'admin@mouse.com', '系统管理员', 1),
('researcher1', '$2a$10$7JB720yubVSOfvVMe6/YqO4wkhWGEn67XVb1Q0K1EFyLWY1uIHe1a', 'researcher1@mouse.com', '研究员1', 2);

INSERT INTO t_device (device_id, device_name, location, api_key) VALUES
('CAM001', '1号摄像头', '实验室A-1号笼', 'test-api-key-001'),
('CAM002', '2号摄像头', '实验室A-2号笼', 'test-api-key-002');

INSERT INTO t_experiment (experiment_name, experiment_code, description, researcher_id) VALUES
('小鼠行为基线测试', 'EXP001', '建立小鼠正常行为基线数据', 2),
('药物A效果评估', 'EXP002', '测试药物A对小鼠行为的影响', 2);
```

## 📥 下载和配置RuoYi框架

### 步骤5: 下载RuoYi-Vue-Plus
```powershell
# 创建后端项目目录
mkdir d:\mouse\backend
cd d:\mouse\backend

# 克隆RuoYi-Vue-Plus项目
git clone https://github.com/dromara/RuoYi-Vue-Plus.git .

# 或者下载ZIP包
# 访问: https://github.com/dromara/RuoYi-Vue-Plus
# 点击 Code -> Download ZIP
# 解压到 d:\mouse\backend 目录
```

### 步骤6: 配置RuoYi项目
```powershell
# 进入项目目录
cd d:\mouse\backend

# 修改数据库配置文件
# 编辑 ruoyi-admin/src/main/resources/application-dev.yml
```

**application-dev.yml 配置内容**:
```yaml
# 数据源配置
spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driverClassName: com.mysql.cj.jdbc.Driver
    druid:
      # 主库数据源
      master:
        url: jdbc:mysql://localhost:3306/mouse_behavior?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
        username: mouse_user
        password: mouse_pass
      # 从库数据源（可选）
      slave:
        enabled: false
  
  # Redis配置
  redis:
    host: localhost
    port: 6379
    password:
    database: 0
    timeout: 10s
    lettuce:
      pool:
        min-idle: 0
        max-idle: 8
        max-active: 8
        max-wait: -1ms
```

### 步骤7: 编译和运行RuoYi
```powershell
# 确保已安装Maven和JDK 17
java -version
mvn -version

# 编译项目
mvn clean install -DskipTests

# 运行后端服务
cd ruoyi-admin
mvn spring-boot:run

# 或者运行jar包
java -jar target/ruoyi-admin.jar
```

### 步骤8: 验证RuoYi运行
```powershell
# 检查服务是否启动
# 浏览器访问: http://localhost:8080
# 查看Swagger文档: http://localhost:8080/doc.html

# 测试API接口
curl http://localhost:8080/actuator/health
```

## 🔧 自定义开发

### 步骤9: 创建小鼠监测相关模块
```powershell
# 在ruoyi-admin/src/main/java/com/ruoyi/web/controller下创建
# mouse包，用于小鼠相关控制器

# 创建以下目录结构:
# com.ruoyi.mouse.controller  - 控制器
# com.ruoyi.mouse.service     - 服务层
# com.ruoyi.mouse.domain      - 实体类
# com.ruoyi.mouse.mapper      - 数据访问层
```

### 步骤10: 创建设备管理模块
**Device实体类** (com/ruoyi/mouse/domain/Device.java):
```java
package com.ruoyi.mouse.domain;

import com.baomidou.mybatisplus.annotation.*;
import com.ruoyi.common.core.domain.BaseEntity;
import lombok.Data;
import lombok.EqualsAndHashCode;

import java.time.LocalDateTime;

@Data
@EqualsAndHashCode(callSuper = true)
@TableName("t_device")
public class Device extends BaseEntity {
    
    @TableId(value = "id", type = IdType.AUTO)
    private Long id;
    
    @TableField("device_id")
    private String deviceId;
    
    @TableField("device_name")
    private String deviceName;
    
    @TableField("device_type")
    private String deviceType;
    
    @TableField("location")
    private String location;
    
    @TableField("ip_address")
    private String ipAddress;
    
    @TableField("mac_address")
    private String macAddress;
    
    @TableField("api_key")
    private String apiKey;
    
    @TableField("status")
    private Integer status;
    
    @TableField("last_heartbeat")
    private LocalDateTime lastHeartbeat;
}
```

### 步骤11: 测试自定义模块
```powershell
# 重新编译项目
mvn clean compile

# 重启服务
# Ctrl+C 停止当前服务
mvn spring-boot:run

# 测试新增的API接口
curl -X GET http://localhost:8080/mouse/device/list
```

## 📊 监控和验证

### 步骤12: 检查系统状态
```powershell
# 检查Docker容器状态
docker-compose ps

# 检查端口占用
netstat -ano | findstr :3306
netstat -ano | findstr :6379
netstat -ano | findstr :8080

# 检查系统资源
docker stats
```

### 步骤13: 创建测试脚本
```powershell
# 创建API测试脚本
# test-api.ps1

$baseUrl = "http://localhost:8080"

# 测试健康检查
Invoke-RestMethod -Uri "$baseUrl/actuator/health" -Method GET

# 测试设备列表API
Invoke-RestMethod -Uri "$baseUrl/mouse/device/list" -Method GET

# 测试登录API
$loginData = @{
    username = "admin"
    password = "admin123"
}
Invoke-RestMethod -Uri "$baseUrl/login" -Method POST -Body ($loginData | ConvertTo-Json) -ContentType "application/json"
```

## 🎯 今日目标检查清单

- [x] ✅ Docker服务正常运行
- [x] ✅ MySQL数据库启动并可连接
- [x] ✅ Redis缓存服务正常
- [x] ✅ MinIO对象存储可访问
- [x] ✅ 数据库表结构创建完成
- [x] ✅ 测试数据插入成功
- [x] ✅ RuoYi框架下载完成
- [x] ✅ RuoYi项目配置正确
- [ ] ⚠️ **需要安装Java/Maven环境**
- [ ] ✅ RuoYi服务启动成功
- [ ] ✅ Swagger文档可访问
- [ ] ✅ 基础API接口测试通过
- [ ] ✅ 自定义设备模块创建
- [ ] ✅ 系统整体运行稳定

## 🚨 常见问题解决

### Docker相关问题
```powershell
# 端口被占用
netstat -ano | findstr :3306
# 找到PID后结束进程
taskkill /PID <PID> /F

# Docker容器启动失败
docker-compose down
docker system prune -f
docker-compose up -d

# 内存不足
docker system df
docker image prune -a
```

### Maven编译问题
```powershell
# 清理Maven缓存
mvn dependency:purge-local-repository

# 重新下载依赖
mvn clean install -U

# 跳过测试编译
mvn clean install -DskipTests -Dmaven.test.skip=true
```

### 数据库连接问题
```sql
-- 检查用户权限
SELECT user, host FROM mysql.user;

-- 创建用户和授权
CREATE USER 'mouse_user'@'%' IDENTIFIED BY 'mouse_pass';
GRANT ALL PRIVILEGES ON mouse_behavior.* TO 'mouse_user'@'%';
FLUSH PRIVILEGES;
```

---

**执行顺序**: 按步骤1-13依次执行
**预计耗时**: 4-6小时
**成功标准**: 所有检查清单项目完成，系统稳定运行
**下一步**: 开始核心业务模块的详细开发