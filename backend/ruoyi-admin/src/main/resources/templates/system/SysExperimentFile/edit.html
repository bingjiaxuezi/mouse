<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('修改实验文件管理')" />
    <th:block th:include="include :: bootstrap-fileinput-css"/>
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-SysExperimentFile-edit" th:object="${sysExperimentFile}">
            <input name="fileId" th:field="*{fileId}" type="hidden">
            <input name="experimentId" th:field="*{experimentId}" type="hidden">
            <input name="fileOriginalName" th:field="*{fileOriginalName}" type="hidden">
            <div class="row">
                <div class="col-xs-12"><h4 style="margin-top:0">基础信息</h4><hr style="margin:10px 0"></div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label is-required">文件名称：</label>
                        <div class="col-sm-8">
                            <input name="fileName" th:field="*{fileName}" class="form-control" type="text" required>
                        </div>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">文件版本：</label>
                        <div class="col-sm-8">
                            <input name="version" th:field="*{version}" class="form-control" type="text">
                        </div>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label is-required">文件类型：</label>
                        <div class="col-sm-8">
                            <select name="fileType" class="form-control" th:with="type=${@dict.getType('sys_file_type')}" required>
                                <option th:each="dict : ${type}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}" th:field="*{fileType}"></option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">文件分类：</label>
                        <div class="col-sm-8">
                            <select name="fileCategory" class="form-control" th:with="type=${@dict.getType('sys_file_category')}">
                                <option th:each="dict : ${type}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}" th:field="*{fileCategory}"></option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12"><h4>文件上传</h4><hr style="margin:10px 0"></div>
                <div class="col-xs-12">
                    <div class="form-group">
                        <label class="col-sm-2 control-label is-required">文件路径：</label>
                        <div class="col-sm-10">
                            <input type="hidden" name="filePath" th:field="*{filePath}">
                            <input type="hidden" name="bucketName" th:field="*{bucketName}">
                            <input type="hidden" name="objectName" th:field="*{objectName}">
                            <div class="file-loading">
                                <input class="form-control file-upload" id="filePath" name="file" type="file">
                            </div>
                            <span class="help-block m-b-none">支持任意类型文件。上传后将自动保存到MinIO，并回填路径与存储信息。</span>
                        </div>
                    </div>
                </div>
                <div class="col-xs-12"><h4>描述信息</h4><hr style="margin:10px 0"></div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">文件描述：</label>
                        <div class="col-sm-8">
                            <textarea name="fileDescription" class="form-control">[[*{fileDescription}]]</textarea>
                        </div>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">文件标签(逗号分隔)：</label>
                        <div class="col-sm-8">
                            <textarea name="fileTags" class="form-control">[[*{fileTags}]]</textarea>
                        </div>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">文件状态：</label>
                        <div class="col-sm-8">
                            <select name="fileStatus" class="form-control" th:with="type=${@dict.getType('sys_file_status')}">
                                <option th:each="dict : ${type}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}" th:field="*{fileStatus}"></option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">备注：</label>
                        <div class="col-sm-8">
                            <textarea name="remark" class="form-control">[[*{remark}]]</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-fileinput-js"/>
    <script th:inline="javascript">
        var prefix = ctx + "system/SysExperimentFile";
        $(function(){
            $("#form-SysExperimentFile-edit").validate({
                focusCleanup: true
            });

            // 初始化上传控件，使用后端MinIO上传接口并携带experimentId
            var val = $("input[name='filePath']").val();
            var experimentId = $("input[name='experimentId']").val();
            var options = {
                uploadUrl: prefix + '/upload',
                uploadExtraData: function(){ return { experimentId: experimentId }; },
                initialPreviewAsData: !!val,
                initialPreview: val ? [val] : [],
                maxFileCount: 1,
                autoReplace: true,
                showUpload: true,
                showRemove: true,
                browseClass: 'btn btn-primary',
                dropZoneEnabled: false
            };
            $("#filePath").fileinput(options)
                .on('fileuploaded', function (event, data) {
                    var rsp = (data.response && data.response.data) || data.response || {};
                    // 回填各字段
                    if (rsp.fileUrl) $("input[name='filePath']").val(rsp.fileUrl);
                    if (rsp.bucketName) $("input[name='bucketName']").val(rsp.bucketName);
                    if (rsp.objectName) $("input[name='objectName']").val(rsp.objectName);
                    if (rsp.originalFileName) {
                        $("input[name='fileOriginalName']").val(rsp.originalFileName);
                        if (!$("input[name='fileName']").val()) {
                            $("input[name='fileName']").val(rsp.originalFileName);
                        }
                    }
                    if (rsp.fileType && !$("select[name='fileType']").val()) {
                        // 若后端返回类型与字典不一致，保持用户选择不变
                    }
                })
                .on('filesuccessremove filecleared', function () {
                    $("input[name='filePath']").val('');
                    $("input[name='bucketName']").val('');
                    $("input[name='objectName']").val('');
                });
        });

        function submitHandler() {
            if ($.validate.form()) {
                $.operate.save(prefix + "/edit", $('#form-SysExperimentFile-edit').serialize());
            }
        }
    </script>
</body>
</html>