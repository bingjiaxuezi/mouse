<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('修改邮件模板')" />
    <th:block th:include="include :: summernote-css" />
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-templates-edit" th:object="${mailTemplates}">
            <input name="templateId" th:field="*{templateId}" type="hidden">
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label">绑定人员：</label>
                    <div class="col-sm-8">
                        <div class="input-group">
                            <input type="text" class="form-control" id="selectedUsers" placeholder="点击选择人员" readonly>
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-primary" onclick="selectUsers()"><i class="fa fa-users"></i> 选择人员</button>
                            </span>
                        </div>
                        <div id="selectedUsersList" class="mt-3" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e6e7; border-radius: 3px; padding: 10px; background-color: #f9f9f9;"></div>
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label is-required">模板编码：</label>
                    <div class="col-sm-8">
                        <input name="templateCode" th:field="*{templateCode}" class="form-control" type="text" required>
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label is-required">邮件主题：</label>
                    <div class="col-sm-8">
                        <input name="subject" th:field="*{subject}" class="form-control" type="text" required>
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label is-required">邮件内容模板：</label>
                    <div class="col-sm-8">
                        <input type="hidden" class="form-control" th:field="*{content}">
                        <div class="summernote" id="content"></div>
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label">模板描述：</label>
                    <div class="col-sm-8">
                        <textarea name="description" class="form-control">[[*{description}]]</textarea>
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="form-group">
                    <label class="col-sm-3 control-label">是否启用: 1-启用, 0-禁用：</label>
                    <div class="col-sm-8">
                        <div class="radio-box" th:each="dict : ${@dict.getType('sys_status')}">
                            <input type="radio" th:id="${'isActive_' + dict.dictCode}" name="isActive" th:value="${dict.dictValue}" th:field="*{isActive}">
                            <label th:for="${'isActive_' + dict.dictCode}" th:text="${dict.dictLabel}"></label>
                        </div>
                    </div>
                </div>
            </div>

        </form>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: summernote-js" />
    <script th:inline="javascript">
        var prefix = ctx + "mail/template";
        var selectedUserIds = [];
        var allUsers = [];
        
        $("#form-templates-edit").validate({
            focusCleanup: true
        });

        function submitHandler() {
            if ($.validate.form()) {
                // 保存模板信息
                $.operate.save(prefix + "/edit", $('#form-templates-edit').serialize(), function(result) {
                    if (result.code == web_status.SUCCESS) {
                        // 保存成功后，更新人员绑定
                        saveUserBindings();
                    }
                });
            }
        }
        
        // 选择人员
        function selectUsers() {
            if (allUsers.length === 0) {
                loadAllUsers();
            }
            showUserSelectModal();
        }
        
        // 加载所有用户
        function loadAllUsers() {
            $.ajax({
                url: ctx + "system/user/list",
                type: "POST",
                data: {
                    pageSize: 100,
                    pageNum: 1
                },
                success: function(result) {
                    if (result.code == 0) {
                        allUsers = result.rows;
                    }
                }
            });
        }
        
        // 显示用户选择模态框
        function showUserSelectModal() {
            var modalHtml = '<div class="modal fade" id="userSelectModal" tabindex="-1" role="dialog">' +
                '<div class="modal-dialog modal-lg" role="document">' +
                '<div class="modal-content">' +
                '<div class="modal-header">' +
                '<h4 class="modal-title">选择人员</h4>' +
                '<button type="button" class="close" data-dismiss="modal">&times;</button>' +
                '</div>' +
                '<div class="modal-body">' +
                '<div class="row">' +
                '<div class="col-md-12">' +
                '<table class="table table-striped table-bordered">' +
                '<thead>' +
                '<tr>' +
                '<th><input type="checkbox" id="selectAllUsers"></th>' +
                '<th>用户名</th>' +
                '<th>姓名</th>' +
                '<th>邮箱</th>' +
                '<th>部门</th>' +
                '</tr>' +
                '</thead>' +
                '<tbody id="userTableBody">' +
                '</tbody>' +
                '</table>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<div class="modal-footer">' +
                '<button type="button" class="btn btn-primary" onclick="confirmUserSelection()">确定</button>' +
                '<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>';
            
            $('body').append(modalHtml);
            
            // 填充用户数据
            var tbody = $('#userTableBody');
            tbody.empty();
            
            $.each(allUsers, function(index, user) {
                var checked = selectedUserIds.indexOf(user.userId) !== -1 ? 'checked' : '';
                var deptName = user.dept ? user.dept.deptName : '';
                var row = '<tr>' +
                    '<td><input type="checkbox" class="user-checkbox" value="' + user.userId + '" ' + checked + '></td>' +
                    '<td>' + user.loginName + '</td>' +
                    '<td>' + user.userName + '</td>' +
                    '<td>' + (user.email || '') + '</td>' +
                    '<td>' + deptName + '</td>' +
                    '</tr>';
                tbody.append(row);
            });
            
            // 全选功能
            $('#selectAllUsers').change(function() {
                $('.user-checkbox').prop('checked', this.checked);
            });
            
            $('#userSelectModal').modal('show');
        }
        
        // 确认用户选择
        function confirmUserSelection() {
            selectedUserIds = [];
            var selectedUsers = [];
            
            $('.user-checkbox:checked').each(function() {
                var userId = parseInt($(this).val());
                selectedUserIds.push(userId);
                
                var user = allUsers.find(u => u.userId === userId);
                if (user) {
                    selectedUsers.push(user);
                }
            });
            
            updateSelectedUsersDisplay(selectedUsers);
            
            // 先移除模态框，再隐藏遮罩层
            $('#userSelectModal').remove();
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open');
        }
        
        // 更新已选用户显示
        function updateSelectedUsersDisplay(users) {
            var displayText = users.length > 0 ? '已选择 ' + users.length + ' 个人员' : '点击选择人员';
            $('#selectedUsers').val(displayText);
            
            var listHtml = '';
            if (users.length === 0) {
                listHtml = '<div class="text-muted text-center" style="padding: 20px;"><i class="fa fa-users fa-2x"></i><br><br>暂无绑定人员<br><small>点击上方"选择人员"按钮添加</small></div>';
            } else {
                $.each(users, function(index, user) {
                    var deptName = user.dept ? user.dept.deptName : '未分配部门';
                    var email = user.email || '未设置邮箱';
                    listHtml += '<div class="user-item" style="display: flex; align-items: center; padding: 8px 12px; margin-bottom: 8px; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">' +
                        '<div class="user-avatar" style="width: 32px; height: 32px; background: #5cb85c; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 12px;">' +
                        user.userName.charAt(0).toUpperCase() +
                        '</div>' +
                        '<div class="user-info" style="flex: 1;">' +
                        '<div style="font-weight: 500; color: #333;">' + user.userName + ' (' + user.loginName + ')</div>' +
                        '<div style="font-size: 12px; color: #666; margin-top: 2px;">' +
                        '<i class="fa fa-building-o"></i> ' + deptName + ' &nbsp;&nbsp;' +
                        '<i class="fa fa-envelope-o"></i> ' + email +
                        '</div>' +
                        '</div>' +
                        '<button type="button" class="btn btn-danger btn-xs" onclick="removeUser(' + user.userId + ')" style="padding: 2px 6px;" title="移除此人员">' +
                        '<i class="fa fa-times"></i>' +
                        '</button>' +
                        '</div>';
                });
            }
            
            $('#selectedUsersList').html(listHtml);
        }
        
        // 移除用户
        function removeUser(userId) {
            var index = selectedUserIds.indexOf(userId);
            if (index !== -1) {
                selectedUserIds.splice(index, 1);
                var selectedUsers = allUsers.filter(u => selectedUserIds.indexOf(u.userId) !== -1);
                updateSelectedUsersDisplay(selectedUsers);
            }
        }
        
        // 保存用户绑定
        function saveUserBindings() {
            var templateId = $('input[name="templateId"]').val();
            if (selectedUserIds.length > 0) {
                $.ajax({
                    url: ctx + "system/recipients/batchAdd",
                    type: "POST",
                    data: {
                        templateId: templateId,
                        recipientIds: selectedUserIds.join(',')
                    },
                    success: function(result) {
                        if (result.code == web_status.SUCCESS) {
                            $.modal.msgSuccess("人员绑定成功");
                        } else {
                            $.modal.alertError(result.msg);
                        }
                    }
                });
            }
        }
        
        // 加载已绑定的用户
        function loadBoundUsers() {
            var templateId = $('input[name="templateId"]').val();
            if (templateId) {
                $.ajax({
                    url: ctx + "system/recipients/listByTemplate",
                    type: "POST",
                    data: {
                        templateId: templateId
                    },
                    success: function(result) {
                        if (result.code == 0 && result.rows) {
                            selectedUserIds = result.rows.map(r => r.recipientId);
                            // 需要获取用户详细信息来显示
                            if (selectedUserIds.length > 0) {
                                loadAllUsers();
                                setTimeout(function() {
                                    var selectedUsers = allUsers.filter(u => selectedUserIds.indexOf(u.userId) !== -1);
                                    updateSelectedUsersDisplay(selectedUsers);
                                }, 500);
                            }
                        }
                    }
                });
            }
        }

        $(function() {
            // 初始化富文本编辑器
            $('.summernote').each(function(i) {
                $('#' + this.id).summernote({
                    lang: 'zh-CN',
                    dialogsInBody: true,
                    callbacks: {
                        onChange: function(contents, $edittable) {
                            $("input[name='" + this.id + "']").val(contents);
                        },
                        onImageUpload: function(files) {
                            var obj = this;
                            var data = new FormData();
                            data.append("file", files[0]);
                            $.ajax({
                                type: "post",
                                url: ctx + "common/upload",
                                data: data,
                                cache: false,
                                contentType: false,
                                processData: false,
                                dataType: 'json',
                                success: function(result) {
                                    if (result.code == web_status.SUCCESS) {
                                        $('#' + obj.id).summernote('insertImage', result.url);
                                    } else {
                                        $.modal.alertError(result.msg);
                                    }
                                },
                                error: function(error) {
                                    $.modal.alertWarning("图片上传失败。");
                                }
                            });
                        }
                    }
                });
                var content = $("input[name='" + this.id + "']").val();
                $('#' + this.id).summernote('code', content);
            });
            
            // 加载所有用户数据
            loadAllUsers();
            
            // 加载已绑定的用户
            setTimeout(function() {
                loadBoundUsers();
            }, 1000);
        });
    </script>
</body>
</html>